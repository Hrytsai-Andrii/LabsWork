package com.example.labs.client;

import javax.sound.sampled.AudioFileFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import java.io.File;

public class AudioConverter {

    public static String getPlayableURI(String filePath) {
        if (filePath.toLowerCase().endsWith(".flac")) {
            return convertFlacToWav(filePath);
        }
        // –î–ª—è MP3/WAV –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–≤–∏—á–∞–π–Ω–∏–π URI
        return new File(filePath).toURI().toString();
    }

    private static String convertFlacToWav(String flacPath) {
        try {
            File flacFile = new File(flacPath);
            File tempWav = File.createTempFile("converted_track_", ".wav");
            tempWav.deleteOnExit(); // –í–∏–¥–∞–ª–∏—Ç–∏ –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–æ–≥—Ä–∞–º–∏

            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Java Sound API (–ø–æ—Ç—Ä–µ–±—É—î jflac –Ω–∞ classpath)
            AudioInputStream flacStream = AudioSystem.getAudioInputStream(flacFile);

            // –ó–∞–ø–∏—Å—É—î–º–æ —è–∫ WAV
            AudioSystem.write(flacStream, AudioFileFormat.Type.WAVE, tempWav);

            flacStream.close();
            return tempWav.toURI().toString();
        } catch (Exception e) {
            System.err.println("–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó FLAC: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }
}

package com.example.labs.client;

import javafx.application.Application;
import javafx.scene.Scene;
import javafx.stage.Stage;

public class MusicPlayerApplication extends Application {

    @Override
    public void start(Stage primaryStage) {
        MusicPlayerView view = new MusicPlayerView();
        MusicPlayerController controller = new MusicPlayerController(view);

        Scene scene = new Scene(view.getView(), 800, 600);
        primaryStage.setTitle("Music Player");
        primaryStage.setScene(scene);

        primaryStage.setOnCloseRequest(event -> {
            controller.onAppClose(); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –≤ –ë–î
            javafx.application.Platform.exit();
            System.exit(0);
        });

        primaryStage.show();
    }

    public static void main(String[] args) {
        launch(args);
    }
}

package com.example.labs.client;

import com.example.labs.common.model.Library;
import com.example.labs.common.model.MusicPlayer;
import com.example.labs.common.model.Playlist;
import com.example.labs.common.model.Track;
import com.example.labs.common.model.User;
import com.example.labs.common.patterns.command.*;
import com.example.labs.common.patterns.memento.Caretaker;
import com.example.labs.common.patterns.memento.PlayerMemento;
import com.example.labs.common.patterns.visitor.DurationVisitor;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.scene.control.*;
import javafx.scene.layout.GridPane;
import javafx.scene.media.Media;
import javafx.scene.media.MediaPlayer;
import javafx.util.Pair;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class MusicPlayerController {

    private final MusicPlayerView view;
    private MusicPlayer musicPlayer;
    private Caretaker caretaker = new Caretaker();

    private final MusicSystemFacade systemFacade;
    // private StateRepository stateRepository; // –í–ò–î–ê–õ–ï–ù–û: –ü–æ—Ä—É—à—É–≤–∞–ª–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É

    private Library mainLibrary;

    public MusicPlayerController(MusicPlayerView view) {
        this.view = view;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ–∞—Å–∞–¥—É (—è–∫–∏–π —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î NetworkClient)
        this.systemFacade = new MusicSystemFacade();
        this.musicPlayer = systemFacade.getPlayer();

        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø 3: –°–ª—É—Ö–∞—á –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ç—Ä–µ–∫—É
        this.musicPlayer.setOnTrackChanged(() -> updateStatusUI());

        attachEventHandlers();

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (–∑–∞–≥–æ—Ä–Ω—É—Ç–æ –≤ runLater –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–µ—Ç–æ–¥—ñ–≤)
        refreshData();
        loadLastState();
    }

    private void attachEventHandlers() {
        Command playCmd = new PlayCommand(musicPlayer);
        Command pauseCmd = new PauseCommand(musicPlayer);
        Command stopCmd = new StopCommand(musicPlayer);
        Command nextCmd = new NextCommand(musicPlayer);
        Command prevCmd = new PreviousCommand(musicPlayer);

        view.getPlayBtn().setOnAction(e -> {
            playCmd.execute();
            updateStatusUI();
        });
        view.getPauseBtn().setOnAction(e -> {
            pauseCmd.execute();
            updateStatusUI();
        });
        view.getStopBtn().setOnAction(e -> {
            stopCmd.execute();
            updateStatusUI();
        });
        view.getNextBtn().setOnAction(e -> {
            caretaker.save(musicPlayer.saveState());
            nextCmd.execute();
            updateStatusUI();
        });
        view.getPrevBtn().setOnAction(e -> {
            prevCmd.execute();
            updateStatusUI();
        });

        view.getVolumeSlider().valueProperty().addListener((obs, oldVal, newVal) ->
                musicPlayer.setVolume(newVal.intValue()));

        view.getRefreshBtn().setOnAction(e -> refreshData());

        view.getPlayLibraryBtn().setOnAction(e -> {
            musicPlayer.setPlayableSource(mainLibrary);
            musicPlayer.play();
            updateStatusUI();
        });

        view.getAddFileBtn().setOnAction(e -> handleAddTrack());
        view.getAddToPlaylistBtn().setOnAction(e -> handleAddToPlaylist());
        view.getCreatePlaylistBtn().setOnAction(e -> handleCreatePlaylist());

        view.getRepeatBtn().setOnAction(e -> {
            musicPlayer.toggleRepeat();
            if (musicPlayer.isRepeat()) view.getRepeatBtn().setStyle("-fx-base: #b6e7c9;");
            else view.getRepeatBtn().setStyle("");
        });

        view.getShuffleBtn().setOnAction(e -> {
            boolean newState = !musicPlayer.isShuffle();
            musicPlayer.setShuffle(newState);
            if (newState) view.getShuffleBtn().setStyle("-fx-base: #b6e7c9;");
            else view.getShuffleBtn().setStyle("");
        });

        if (view.getLoginBtn() != null) view.getLoginBtn().setOnAction(e -> handleLogin());
        if (view.getRegisterBtn() != null) view.getRegisterBtn().setOnAction(e -> handleRegister());
        if (view.getLogoutBtn() != null) view.getLogoutBtn().setOnAction(e -> handleLogout());

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ (ContextMenu)
        view.getLibraryTable().setRowFactory(tv -> {
            TableRow<Track> row = new TableRow<>();
            ContextMenu contextMenu = new ContextMenu();
            MenuItem editItem = new MenuItem("–†–µ–¥–∞–≥—É–≤–∞—Ç–∏");
            MenuItem deleteItem = new MenuItem("–í–∏–¥–∞–ª–∏—Ç–∏");

            editItem.setOnAction(event -> handleEditTrack(row.getItem()));
            deleteItem.setOnAction(event -> handleDeleteTrack(row.getItem()));

            contextMenu.getItems().addAll(editItem, deleteItem);
            row.contextMenuProperty().bind(
                    javafx.beans.binding.Bindings.when(row.emptyProperty())
                            .then((ContextMenu) null)
                            .otherwise(contextMenu)
            );

            row.setOnMouseClicked(event -> {
                if (event.getClickCount() == 2 && (!row.isEmpty()) && event.getButton() == javafx.scene.input.MouseButton.PRIMARY) {
                    Track selectedTrack = row.getItem();
                    musicPlayer.setPlayableSource(mainLibrary);
                    musicPlayer.playTrack(selectedTrack);
                    updateStatusUI();
                }
            });
            return row;
        });

        view.getPlaylistListView().setOnMouseClicked(event -> {
            if (event.getClickCount() == 2) {
                Playlist selectedPlaylist = view.getPlaylistListView().getSelectionModel().getSelectedItem();
                if (selectedPlaylist != null) {
                    musicPlayer.setPlayableSource(selectedPlaylist);
                    musicPlayer.play();
                    updateStatusUI();
                }
            }
        });

        view.setOnEditPlaylist(playlist -> {
            TextInputDialog dialog = new TextInputDialog(playlist.getName());
            dialog.setTitle("–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–ª–µ–π–ª–∏—Å—Ç–∞");
            dialog.setHeaderText("–ó–º—ñ–Ω–∏—Ç–∏ –Ω–∞–∑–≤—É –ø–ª–µ–π–ª–∏—Å—Ç–∞");
            dialog.setContentText("–ù–æ–≤–∞ –Ω–∞–∑–≤–∞:");
            Optional<String> result = dialog.showAndWait();

            result.ifPresent(newName -> {
                if (!newName.trim().isEmpty()) {
                    playlist.setName(newName);
                    systemFacade.getPlaylistService().updatePlaylist(playlist); // –ú–µ—Ä–µ–∂–µ–≤–∏–π –≤–∏–∫–ª–∏–∫
                    refreshData();
                }
            });
        });

        view.setOnDeletePlaylist(playlist -> {
            Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
            alert.setTitle("–í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–ª–µ–π–ª–∏—Å—Ç–∞");
            alert.setHeaderText("–í–∏–¥–∞–ª–∏—Ç–∏ –ø–ª–µ–π–ª–∏—Å—Ç '" + playlist.getName() + "'?");
            alert.setContentText("–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.");
            Optional<ButtonType> result = alert.showAndWait();
            if (result.isPresent() && result.get() == ButtonType.OK) {
                if (musicPlayer.getCurrentUser() != null) musicPlayer.stop();
                systemFacade.getPlaylistService().deletePlaylist(playlist.getPlaylistID()); // –ú–µ—Ä–µ–∂–µ–≤–∏–π –≤–∏–∫–ª–∏–∫
                refreshData();
            }
        });

        view.setTrackLoader(playlist -> {
            List<Track> tracksInPlaylist = new ArrayList<>();
            for (Integer trackId : playlist.getTracks()) {
                // –í–∏–∫–ª–∏–∫ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤—ñ–ª—å–Ω–∏–º, –∞–ª–µ trackLoader –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ –∫–ª—ñ–∫—É –≤ UI.
                // –í —ñ–¥–µ–∞–ª—ñ - –∫–µ—à—É–≤–∞—Ç–∏, –∞–ª–µ —Ç—É—Ç –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ —î.
                Track t = systemFacade.getTrackService().getTrackByID(trackId);
                if (t != null) tracksInPlaylist.add(t);
            }
            return tracksInPlaylist;
        });

        view.setOnPlayTrackFromPlaylist((playlist, track) -> {
            musicPlayer.setPlayableSource(playlist);
            musicPlayer.playTrack(track);
            updateStatusUI();
        });

        view.setOnAddTrackToPlaylist(playlist -> {
            // –û—Ç—Ä–∏–º—É—î–º–æ —Ç—Ä–µ–∫–∏ (–º–µ—Ä–µ–∂–µ–≤–∏–π –≤–∏–∫–ª–∏–∫), —Ç—Ä–µ–±–∞ –±—É—Ç–∏ –æ–±–µ—Ä–µ–∂–Ω–∏–º –∑ UI
            List<Track> allTracks = systemFacade.getCurrentUserTracks();
            Track selectedTrack = view.showTrackSelectionDialog(allTracks);

            if (selectedTrack != null) {
                if (playlist.getTracks().contains(selectedTrack.getTrackID())) {
                    view.showAlert("–£–≤–∞–≥–∞", "–¢—Ä–µ–∫ –≤–∂–µ —î —É –ø–ª–µ–π–ª–∏—Å—Ç—ñ.");
                } else {
                    playlist.addTrack(selectedTrack.getTrackID());
                    systemFacade.getPlaylistService().updatePlaylist(playlist);
                    refreshData();
                }
            }
        });

        view.setDurationCalculator(playlist -> {
            DurationVisitor visitor = new DurationVisitor();
            List<Integer> trackIds = playlist.getTracks();
            for (Integer id : trackIds) {
                Track track = systemFacade.getTrackService().getTrackByID(id);
                if (track != null) {
                    track.accept(visitor);
                }
            }
            return visitor.getFormattedDuration();
        });
    }

    private void refreshData() {
        if (musicPlayer.getCurrentUser() == null) return;

        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø 3: –í—Å—ñ –∑–º—ñ–Ω–∏ UI –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ JavaFX
        Platform.runLater(() -> {
            view.updateAuthUI(musicPlayer.getCurrentUser());
        });

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ (—Ü–µ –±–ª–æ–∫—É—é—á—ñ –≤–∏–∫–ª–∏–∫–∏ –º–µ—Ä–µ–∂—ñ, –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É –∫—Ä–∞—â–µ Task<Void>,
        // –∞–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –∫—É—Ä—Å–æ–≤–æ—ó –≤–∏–∫–æ–Ω—É—î–º–æ —Ç—É—Ç, –∞ UI –æ–Ω–æ–≤–ª—é—î–º–æ –≤ runLater)
        List<Track> tracks = systemFacade.getCurrentUserTracks();

        Platform.runLater(() -> {
            view.getLibraryTable().setItems(FXCollections.observableArrayList(tracks));
            mainLibrary = new Library();
            tracks.forEach(mainLibrary::addTrack);
        });

        List<Playlist> playlists = systemFacade.getCurrentUserPlaylists();

        Platform.runLater(() -> {
            view.getPlaylistListView().setItems(FXCollections.observableArrayList(playlists));
            view.getStatusLabel().setText((musicPlayer.isPlaying() ? "–ì—Ä–∞—î..." : "–ü–∞—É–∑–∞"));
        });
    }

    private void updateStatusUI() {
        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø 3: –ì–∞—Ä–∞–Ω—Ç—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤ UI –ø–æ—Ç–æ—Ü—ñ
        Platform.runLater(() -> {
            if (musicPlayer.isPlaying()) {
                view.getStatusLabel().setText("–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è");
                view.getStatusLabel().setStyle("-fx-text-fill: green; -fx-font-size: 12px;");
            } else {
                view.getStatusLabel().setText("–ó—É–ø–∏–Ω–µ–Ω–æ");
                view.getStatusLabel().setStyle("-fx-text-fill: black; -fx-font-size: 12px;");
            }

            Track current = musicPlayer.getCurrentTrack();
            if (current != null) {
                String artist = (current.getArtist() == null || current.getArtist().isEmpty()) ?
                        "–ù–µ–≤—ñ–¥–æ–º–∏–π" : current.getArtist();
                String title = (current.getTitle() == null || current.getTitle().isEmpty()) ? "–ë–µ–∑ –Ω–∞–∑–≤–∏" : current.getTitle();
                view.getCurrentTrackLabel().setText(artist + " - " + title);
            } else {
                view.getCurrentTrackLabel().setText("–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫—É");
            }
        });
    }

    private void handleLogin() {
        Dialog<Pair<String, String>> dialog = new Dialog<>();
        dialog.setTitle("–í—Ö—ñ–¥");
        dialog.setHeaderText("–í–≤–µ–¥—ñ—Ç—å Email —Ç–∞ –ø–∞—Ä–æ–ª—å");
        ButtonType loginButtonType = new ButtonType("–£–≤—ñ–π—Ç–∏", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(loginButtonType, ButtonType.CANCEL);

        GridPane grid = new GridPane();
        grid.setHgap(10); grid.setVgap(10);
        TextField email = new TextField(); email.setPromptText("Email");
        PasswordField password = new PasswordField(); password.setPromptText("Password");

        grid.add(new Label("Email:"), 0, 0); grid.add(email, 1, 0);
        grid.add(new Label("Password:"), 0, 1); grid.add(password, 1, 1);
        dialog.getDialogPane().setContent(grid);

        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == loginButtonType) return new Pair<>(email.getText(), password.getText());
            return null;
        });

        dialog.showAndWait().ifPresent(credentials -> {
            saveCurrentUserState();

            User user = systemFacade.authenticate(credentials.getKey(), credentials.getValue());
            if (user != null) {
                refreshData();
                loadLastState();
            } else {
                view.showAlert("–ü–æ–º–∏–ª–∫–∞", "–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å");
            }
        });
        updateStatusUI();
    }

    private void handleRegister() {
        Dialog<String[]> dialog = new Dialog<>();
        dialog.setTitle("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è");
        dialog.setHeaderText("–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç");
        ButtonType regButtonType = new ButtonType("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(regButtonType, ButtonType.CANCEL);

        GridPane grid = new GridPane();
        grid.setHgap(10); grid.setVgap(10);
        TextField name = new TextField(); name.setPromptText("–Ü–º'—è");
        TextField email = new TextField(); email.setPromptText("Email");
        PasswordField password = new PasswordField(); password.setPromptText("Password");
        grid.add(new Label("–Ü–º'—è:"), 0, 0); grid.add(name, 1, 0);
        grid.add(new Label("Email:"), 0, 1); grid.add(email, 1, 1);
        grid.add(new Label("Password:"), 0, 2); grid.add(password, 1, 2);
        dialog.getDialogPane().setContent(grid);

        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == regButtonType) return new String[]{name.getText(), email.getText(), password.getText()};
            return null;
        });

        dialog.showAndWait().ifPresent(data -> {
            saveCurrentUserState();

            User newUser = systemFacade.register(data[0], data[1], data[2]);
            if (newUser != null) {
                refreshData();
                loadLastState();
            } else {
                view.showAlert("–ü–æ–º–∏–ª–∫–∞", "Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.");
            }
        });
        updateStatusUI();
    }

    private void handleLogout() {
        saveCurrentUserState();
        systemFacade.logout();
        refreshData();
        loadLastState();
        updateStatusUI();
    }

    private void handleAddTrack() {
        File file = view.showFileChooser();
        if (file != null) {
            Dialog<Track> dialog = new Dialog<>();
            dialog.setTitle("–î–æ–¥–∞—Ç–∏ —Ç—Ä–µ–∫");
            dialog.getDialogPane().getButtonTypes().addAll(ButtonType.OK, ButtonType.CANCEL);

            GridPane grid = new GridPane();
            grid.setHgap(10); grid.setVgap(10);

            TextField titleField = new TextField(file.getName().replaceFirst("[.][^.]+$", ""));
            TextField artistField = new TextField("–ù–µ–≤—ñ–¥–æ–º–∏–π");
            TextField albumField = new TextField("–ù–µ–≤—ñ–¥–æ–º–∏–π");

            grid.add(new Label("–ù–∞–∑–≤–∞:"), 0, 0); grid.add(titleField, 1, 0);
            grid.add(new Label("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:"), 0, 1); grid.add(artistField, 1, 1);
            grid.add(new Label("–ê–ª—å–±–æ–º:"), 0, 2); grid.add(albumField, 1, 2);

            dialog.getDialogPane().setContent(grid);
            dialog.setResultConverter(btn -> {
                if (btn == ButtonType.OK) {
                    return new Track(0,
                            titleField.getText(),
                            artistField.getText(),
                            albumField.getText(),
                            0.0,
                            file.getAbsolutePath());
                }
                return null;
            });
            Optional<Track> result = dialog.showAndWait();
            result.ifPresent(this::saveTrackWithDuration);
        }
    }

    private void saveTrackWithDuration(Track track) {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è (Task) –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —É —Ñ–æ–Ω–æ–≤–æ–º—É –ø–æ—Ç–æ—Ü—ñ
        javafx.concurrent.Task<String> conversionTask = new javafx.concurrent.Task<>() {
            @Override
            protected String call() throws Exception {
                // –¶–µ–π –∫–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ù–ï –≤ UI –ø–æ—Ç–æ—Ü—ñ, —Ç–æ–º—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∑–∞–≤–∏—Å–Ω–µ
                return AudioConverter.getPlayableURI(track.getFilePath());
            }
        };

        // –©–æ —Ä–æ–±–∏—Ç–∏, –∫–æ–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
        conversionTask.setOnSucceeded(event -> {
            String uri = conversionTask.getValue(); // –û—Ç—Ä–∏–º—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

            if (uri == null) {
                // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ —î (–±–µ–∑ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –∞–±–æ 0.0)
                saveTrackToDB(track);
                return;
            }

            try {
                Media media = new Media(uri);
                MediaPlayer tempPlayer = new MediaPlayer(media);

                tempPlayer.setOnReady(() -> {
                    track.setDuration(media.getDuration().toSeconds());
                    tempPlayer.dispose();
                    saveTrackToDB(track); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∂–µ –∑ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—é
                });

                tempPlayer.setOnError(() -> {
                    System.err.println("Media error: " + tempPlayer.getError());
                    tempPlayer.dispose();
                    saveTrackToDB(track);
                });

            } catch (Exception e) {
                e.printStackTrace();
                saveTrackToDB(track);
            }
        });

        // –©–æ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ –ø—ñ–¥ —á–∞—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞
        conversionTask.setOnFailed(event -> {
            Throwable e = conversionTask.getException();
            System.err.println("–ü–æ–º–∏–ª–∫–∞ —É —Ñ–æ–Ω–æ–≤–æ–º—É –ø–æ—Ç–æ—Ü—ñ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: " + e.getMessage());
            saveTrackToDB(track);
        });

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ –Ω–æ–≤–æ–º—É –ø–æ—Ç–æ—Ü—ñ
        new Thread(conversionTask).start();
    }

    private void saveTrackToDB(Track track) {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ–∞—Å–∞–¥ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ç—Ä–µ–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        systemFacade.addTrackToLibrary(track);
        refreshData();
    }

    private void handleAddToPlaylist() {
        Track selectedTrack = view.getLibraryTable().getSelectionModel().getSelectedItem();
        if (selectedTrack == null) {
            view.showAlert("–ü–æ–º–∏–ª–∫–∞", "–í–∏–±–µ—Ä—ñ—Ç—å —Ç—Ä–µ–∫!");
            return;
        }

        List<Playlist> playlists = systemFacade.getCurrentUserPlaylists();
        if (playlists.isEmpty()) {
            view.showAlert("–ü–æ–º–∏–ª–∫–∞", "–ù–µ–º–∞—î –ø–ª–µ–π–ª–∏—Å—Ç—ñ–≤.");
            return;
        }

        ChoiceDialog<Playlist> dialog = new ChoiceDialog<>(playlists.get(0), playlists);
        dialog.setTitle("–î–æ–¥–∞—Ç–∏ –¥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
        dialog.setHeaderText("–î–æ–¥–∞—Ç–∏: " + selectedTrack.getTitle());
        dialog.setContentText("–ü–ª–µ–π–ª–∏—Å—Ç:");

        dialog.showAndWait().ifPresent(playlist -> {
            playlist.addTrack(selectedTrack.getTrackID());
            systemFacade.getPlaylistService().updatePlaylist(playlist); // –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–∞–ø–∏—Ç
            refreshData();
        });
    }

    private void handleCreatePlaylist() {
        String name = view.getNewPlaylistNameField().getText();
        if (!name.isEmpty()) {
            Playlist pl = new Playlist(0, name);
            // 1. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–ª–µ–π–ª–∏—Å—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
            Playlist createdPl = systemFacade.getPlaylistService().createPlaylist(pl);

            // 2. –õ—ñ–Ω–∫—É—î–º–æ –¥–æ —é–∑–µ—Ä–∞ (—è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑—Ä–æ–±–∏–≤ —Ü—å–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∞–ª–µ –∑–∞–∑–≤–∏—á–∞–π —Ü–µ –æ–∫—Ä–µ–º–∏–π –∫—Ä–æ–∫)
            if (musicPlayer.getCurrentUser() != null && createdPl != null) {
                systemFacade.getPlaylistService().linkPlaylistToUser(
                        musicPlayer.getCurrentUser().getUserID(),
                        createdPl.getPlaylistID()
                );
            }

            view.getNewPlaylistNameField().clear();
            refreshData();
        }
    }

    private void handleEditTrack(Track track) {
        if (track == null) return;
        Dialog<Track> dialog = new Dialog<>();
        dialog.setTitle("–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç—Ä–µ–∫");
        dialog.getDialogPane().getButtonTypes().addAll(ButtonType.OK, ButtonType.CANCEL);

        GridPane grid = new GridPane();
        grid.setHgap(10); grid.setVgap(10);
        TextField titleField = new TextField(track.getTitle());
        TextField artistField = new TextField(track.getArtist());
        TextField albumField = new TextField(track.getAlbum());

        grid.add(new Label("–ù–∞–∑–≤–∞:"), 0, 0); grid.add(titleField, 1, 0);
        grid.add(new Label("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:"), 0, 1); grid.add(artistField, 1, 1);
        grid.add(new Label("–ê–ª—å–±–æ–º:"), 0, 2); grid.add(albumField, 1, 2);
        dialog.getDialogPane().setContent(grid);

        dialog.setResultConverter(btn -> {
            if (btn == ButtonType.OK) {
                track.setTitle(titleField.getText());
                track.setArtist(artistField.getText());
                track.setAlbum(albumField.getText());
                return track;
            }
            return null;
        });

        Optional<Track> result = dialog.showAndWait();
        result.ifPresent(updatedTrack -> {
            systemFacade.getTrackService().updateTrack(updatedTrack); // –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–∞–ø–∏—Ç
            refreshData();
        });
    }

    private void handleDeleteTrack(Track track) {
        if (track == null) return;
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("–í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç—Ä–µ–∫—É");
        alert.setHeaderText("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç—Ä–µ–∫?");
        alert.setContentText(track.getArtist() + " - " + track.getTitle());

        Optional<ButtonType> result = alert.showAndWait();
        if (result.isPresent() && result.get() == ButtonType.OK) {
            if (musicPlayer.getCurrentTrack() != null && musicPlayer.getCurrentTrack().equals(track)) {
                musicPlayer.stop();
            }
            systemFacade.getTrackService().deleteTrack(track.getTrackID()); // –ú–µ—Ä–µ–∂–µ–≤–∏–π –∑–∞–ø–∏—Ç
            refreshData();
        }
    }

    private void loadLastState() {
        if (musicPlayer.getCurrentUser() == null) return;

        // –í–ò–ü–†–ê–í–õ–ï–ù–û: –í–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥
        PlayerMemento savedState = systemFacade.loadState(musicPlayer.getCurrentUser().getUserID());

        if (savedState != null) {
            musicPlayer.restoreState(savedState);
            view.getVolumeSlider().setValue(savedState.getVolume());

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –∫–Ω–æ–ø–æ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Å—Ç–∞–Ω—É
            if (savedState.isShuffle()) view.getShuffleBtn().setStyle("-fx-base: #b6e7c9;");
            else view.getShuffleBtn().setStyle("");

            if (savedState.isRepeat()) view.getRepeatBtn().setStyle("-fx-base: #b6e7c9;");
            else view.getRepeatBtn().setStyle("");

            updateStatusUI();
        }
    }

    private void saveCurrentUserState() {
        if (musicPlayer.getCurrentUser() != null) {
            PlayerMemento currentState = musicPlayer.saveState();
            // –í–ò–ü–†–ê–í–õ–ï–ù–û: –í–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥
            systemFacade.saveState(musicPlayer.getCurrentUser().getUserID(), currentState);
        }
    }

    public void onAppClose() {
        saveCurrentUserState();
        musicPlayer.stop();
        Platform.exit();
    }
}

package com.example.labs.client;

import com.example.labs.common.model.Playlist;
import com.example.labs.common.model.Track;
import com.example.labs.common.model.User;
import javafx.beans.property.SimpleObjectProperty;
import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.event.ActionEvent;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.scene.shape.SVGPath;
import javafx.stage.FileChooser;

import java.io.File;
import java.util.List;
import java.util.function.BiConsumer;
import java.util.function.Consumer;
import java.util.function.Function;

public class MusicPlayerView {

    private BorderPane root;

    // –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å
    private Label statusLabel;
    private Label currentTrackLabel;

    // –ï–ª–µ–º–µ–Ω—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    private Label userNameLabel; // –ù–æ–≤–∏–π –ª–µ–π–±–ª –¥–ª—è —ñ–º–µ–Ω—ñ
    private Button loginBtn;
    private Button registerBtn;
    private Button logoutBtn;

    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å
    private TableView<Track> libraryTable;
    private ListView<Playlist> playlistListView;

    // –ù–∏–∂–Ω—è –ø–∞–Ω–µ–ª—å (–∫–æ–Ω—Ç—Ä–æ–ª–∏)
    private Slider volumeSlider;
    private Button playBtn, pauseBtn, stopBtn, nextBtn, prevBtn;
    private Button repeatBtn, shuffleBtn;

    // –ö–Ω–æ–ø–∫–∏ –¥—ñ–π
    private Button refreshBtn, playLibraryBtn, addFileBtn, addToPlaylistBtn;
    private Button createPlaylistBtn, playPlaylistBtn;
    private TextField newPlaylistNameField;

    // Callbacks –¥–ª—è Controller
    private Function<Playlist, List<Track>> trackLoader;
    private BiConsumer<Playlist, Track> onPlayTrackFromPlaylist;
    private Consumer<Playlist> onAddTrackToPlaylist;
    private Consumer<Playlist> onEditPlaylist;
    private Consumer<Playlist> onDeletePlaylist;
    private Function<Playlist, String> durationCalculator;

    public MusicPlayerView() {
        createUI();
    }

    public Parent getView() {
        return root;
    }

    private void createUI() {
        root = new BorderPane();
        root.setPadding(new Insets(10));

        // --- –í–ï–†–•–ù–Ø –ß–ê–°–¢–ò–ù–ê (Auth + Info) ---
        VBox topContainer = new VBox(10);
        topContainer.setPadding(new Insets(0, 0, 10, 0));
        topContainer.setAlignment(Pos.CENTER);

        // –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (—Å–ø—Ä–∞–≤–∞ –∑–≤–µ—Ä—Ö—É)
        HBox authBox = new HBox(10);
        authBox.setAlignment(Pos.CENTER_RIGHT);

        // –õ–µ–π–±–ª —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        userNameLabel = new Label();
        userNameLabel.setStyle("-fx-font-weight: bold; -fx-text-fill: #333; -fx-font-size: 14px; -fx-padding: 0 10 0 0;");

        loginBtn = new Button("–í—Ö—ñ–¥");
        registerBtn = new Button("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è");
        logoutBtn = new Button("–í–∏—Ö—ñ–¥");

        // –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫
        loginBtn.setStyle("-fx-base: #3498db; -fx-text-fill: white; -fx-cursor: hand;");
        registerBtn.setStyle("-fx-base: #2ecc71; -fx-text-fill: white; -fx-cursor: hand;");
        logoutBtn.setStyle("-fx-base: #e74c3c; -fx-text-fill: white; -fx-cursor: hand;");

        authBox.getChildren().addAll(userNameLabel, loginBtn, registerBtn, logoutBtn);

        // –Ü–Ω—Ñ–æ –ø—Ä–æ —Ç—Ä–µ–∫
        currentTrackLabel = new Label("–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫—É");
        currentTrackLabel.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        statusLabel = new Label("–°—Ç–∞—Ç—É—Å: –ó—É–ø–∏–Ω–µ–Ω–æ");
        statusLabel.setStyle("-fx-font-size: 12px;");

        topContainer.getChildren().addAll(authBox, currentTrackLabel, statusLabel);
        root.setTop(topContainer);

        // --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê –ß–ê–°–¢–ò–ù–ê (Tabs) ---
        TabPane tabPane = new TabPane();
        tabPane.getTabs().addAll(
                new Tab("–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞", createLibraryTab()),
                new Tab("–ü–ª–µ–π–ª–∏—Å—Ç–∏", createPlaylistTab())
        );
        tabPane.getTabs().forEach(t -> t.setClosable(false));
        root.setCenter(tabPane);

        // --- –ù–ò–ñ–ù–Ø –ß–ê–°–¢–ò–ù–ê (Controls) ---
        root.setBottom(createControlsBox());
    }

    /**
     * –û–Ω–æ–≤–ª—é—î –≤–∏–¥–∏–º—ñ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —Ö—Ç–æ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π.
     */
    public void updateAuthUI(User currentUser) {
        // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ ID 1 - —Ü–µ –∑–∞–≤–∂–¥–∏ Default User (–ì—ñ—Å—Ç—å)
        boolean isDefaultUser = (currentUser.getUserID() == 1);

        if (isDefaultUser) {
            // --- –†–ï–ñ–ò–ú –ì–û–°–¢–Ø ---
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ: –í—Ö—ñ–¥, –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
            // –•–æ–≤–∞—î–º–æ: –Ü–º'—è, –í–∏—Ö—ñ–¥

            userNameLabel.setVisible(false); userNameLabel.setManaged(false);
            logoutBtn.setVisible(false);     logoutBtn.setManaged(false);

            loginBtn.setVisible(true);       loginBtn.setManaged(true);
            registerBtn.setVisible(true);    registerBtn.setManaged(true);
        } else {
            // --- –†–ï–ñ–ò–ú –ö–û–†–ò–°–¢–£–í–ê–ß–ê ---
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ: –Ü–º'—è, –í—Ö—ñ–¥, –í–∏—Ö—ñ–¥
            // –•–æ–≤–∞—î–º–æ: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è

            userNameLabel.setText(currentUser.getName());
            userNameLabel.setVisible(true);  userNameLabel.setManaged(true);

            logoutBtn.setVisible(true);      logoutBtn.setManaged(true);
            loginBtn.setVisible(true);       loginBtn.setManaged(true); // –ó–∞–ª–∏—à–∞—î–º–æ "–í—Ö—ñ–¥" –≤–∏–¥–∏–º–∏–º –∑–∞ –≤–∞—à–∏–º –±–∞–∂–∞–Ω–Ω—è–º

            registerBtn.setVisible(false);   registerBtn.setManaged(false);
        }
    }

    private VBox createLibraryTab() {
        VBox box = new VBox(10);
        box.setPadding(new Insets(10));

        // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é
        HBox buttonBox = new HBox(10);
        playLibraryBtn = new Button("‚ñ∂ –ì—Ä–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É");
        playLibraryBtn.setStyle("-fx-base: #b6e7c9;");

        addFileBtn = new Button("‚ûï –î–æ–¥–∞—Ç–∏ —Ç—Ä–µ–∫");
        addToPlaylistBtn = new Button("üìÇ –£ –ø–ª–µ–π–ª–∏—Å—Ç...");
        refreshBtn = new Button("üîÑ –û–Ω–æ–≤–∏—Ç–∏");

        buttonBox.getChildren().addAll(playLibraryBtn, addFileBtn, addToPlaylistBtn, refreshBtn);

        // –¢–∞–±–ª–∏—Ü—è
        libraryTable = new TableView<>();

        TableColumn<Track, String> titleCol = new TableColumn<>("–ù–∞–∑–≤–∞");
        titleCol.setCellValueFactory(data -> new SimpleStringProperty(data.getValue().getTitle()));

        TableColumn<Track, String> artistCol = new TableColumn<>("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å");
        artistCol.setCellValueFactory(data -> new SimpleStringProperty(data.getValue().getArtist()));

        TableColumn<Track, Double> durationCol = getTrackDoubleTableColumn();

        libraryTable.getColumns().addAll(titleCol, artistCol, durationCol);
        libraryTable.setColumnResizePolicy(TableView.CONSTRAINED_RESIZE_POLICY);
        VBox.setVgrow(libraryTable, Priority.ALWAYS);

        box.getChildren().addAll(buttonBox, libraryTable);
        return box;
    }

    private static TableColumn<Track, Double> getTrackDoubleTableColumn() {
        TableColumn<Track, Double> durationCol = new TableColumn<>("–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å");
        durationCol.setCellValueFactory(data -> new SimpleObjectProperty<>(data.getValue().getDuration()));
        durationCol.setCellFactory(column -> new TableCell<Track, Double>() {
            @Override
            protected void updateItem(Double seconds, boolean empty) {
                super.updateItem(seconds, empty);
                if (empty || seconds == null) {
                    setText(null);
                } else {
                    int min = (int) (seconds / 60);
                    int sec = (int) (seconds % 60);
                    setText(String.format("%d:%02d", min, sec));
                }
            }
        });
        return durationCol;
    }

    private VBox createPlaylistTab() {
        VBox box = new VBox(15);
        box.setPadding(new Insets(20));
        box.setStyle("-fx-background-color: #f4f4f4;");

        playlistListView = new ListView<>();
        playlistListView.setStyle("-fx-background-color: transparent; -fx-control-inner-background: #f4f4f4;");
        VBox.setVgrow(playlistListView, Priority.ALWAYS);

        playlistListView.setCellFactory(param -> new ListCell<>() {
            private final TableView<Track> innerTable = new TableView<>();
            private final VBox root = new VBox(0);
            private final HBox cardHeader = new HBox(10);
            private boolean isExpanded = false;

            {
                cardHeader.setAlignment(Pos.CENTER_LEFT);
                cardHeader.setPadding(new Insets(10));
                cardHeader.setStyle("-fx-background-color: white; -fx-background-radius: 10; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 5, 0, 0, 1); -fx-cursor: hand;");

                TableColumn<Track, String> titleCol = new TableColumn<>("–ù–∞–∑–≤–∞");
                titleCol.setCellValueFactory(data -> new SimpleStringProperty(data.getValue().getTitle()));

                TableColumn<Track, String> artistCol = new TableColumn<>("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å");
                artistCol.setCellValueFactory(data -> new SimpleStringProperty(data.getValue().getArtist()));

                TableColumn<Track, String> timeCol = new TableColumn<>("–ß–∞—Å");
                timeCol.setCellValueFactory(data -> new SimpleStringProperty(String.format("%d:%02d", (int) data.getValue().getDuration() / 60, (int) data.getValue().getDuration() % 60)));
                timeCol.setPrefWidth(60);

                innerTable.getColumns().addAll(titleCol, artistCol, timeCol);
                innerTable.setColumnResizePolicy(TableView.CONSTRAINED_RESIZE_POLICY);
                innerTable.setPrefHeight(200);
                innerTable.setVisible(false);
                innerTable.setManaged(false);

                root.getChildren().addAll(cardHeader, innerTable);
            }

            @Override
            protected void updateItem(Playlist item, boolean empty) {
                super.updateItem(item, empty);

                if (empty || item == null) {
                    setGraphic(null);
                    setText(null);
                    setStyle("-fx-background-color: transparent;");
                } else {
                    cardHeader.getChildren().clear();

                    // --- 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–Ü–∫–æ–Ω–∫–∞, –ù–∞–∑–≤–∞, –Ü–Ω—Ñ–æ) ---
                    Label icon = new Label(isExpanded ? "üìÇ" : "üìÅ");
                    icon.setStyle("-fx-font-size: 24px; -fx-text-fill: #555;");

                    VBox info = new VBox(3);
                    Label nameLabel = new Label(item.getName());
                    nameLabel.setStyle("-fx-font-weight: bold; -fx-font-size: 14px; -fx-text-fill: #333;");

                    String infoText = "–¢—Ä–µ–∫—ñ–≤: " + item.getTracks().size();
                    if (durationCalculator != null) {
                        infoText += " ‚Ä¢ " + durationCalculator.apply(item);
                    }
                    Label detailsLabel = new Label(infoText);
                    detailsLabel.setStyle("-fx-font-size: 11px; -fx-text-fill: #888;");
                    info.getChildren().addAll(nameLabel, detailsLabel);

                    Region spacer = new Region();
                    HBox.setHgrow(spacer, Priority.ALWAYS);

                    // --- 2. –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è (–†–µ–¥–∞–≥—É–≤–∞—Ç–∏, –í–∏–¥–∞–ª–∏—Ç–∏, –î–æ–¥–∞—Ç–∏) ---
                    Button editBtn = createIconButton("M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z", "#95a5a6", "#f39c12", e -> {
                        if (onEditPlaylist != null) onEditPlaylist.accept(item);
                    });

                    Button deleteBtn = createIconButton("M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z", "#95a5a6", "#e74c3c", e -> {
                        if (onDeletePlaylist != null) onDeletePlaylist.accept(item);
                    });

                    Button addBtn = createIconButton("M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z", "#95a5a6", "#2ecc71", e -> {
                        if (onAddTrackToPlaylist != null) onAddTrackToPlaylist.accept(item);
                    });

                    Label arrow = new Label(isExpanded ? "‚ñ≤" : "‚ñº");
                    arrow.setStyle("-fx-font-size: 12px; -fx-text-fill: #888; -fx-padding: 0 0 0 10;");

                    cardHeader.getChildren().addAll(icon, info, spacer, addBtn, editBtn, deleteBtn, arrow);

                    // --- 3. –õ–æ–≥—ñ–∫–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ ---
                    cardHeader.setOnMouseClicked(event -> {
                        // –Ü–≥–Ω–æ—Ä—É—î–º–æ, —è–∫—â–æ –∫–ª—ñ–∫–Ω—É–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–∞—Ö
                        if (event.getTarget() instanceof Button || event.getTarget() instanceof SVGPath) return;

                        isExpanded = !isExpanded;
                        updateTableVisibility(item, icon, arrow);
                    });

                    // --- 4. –í–ê–ñ–õ–ò–í–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ, —è–∫—â–æ –≤–æ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ ---
                    if (isExpanded) {
                        updateTableVisibility(item, icon, arrow);
                    }

                    // --- 5. –í–ê–ñ–õ–ò–í–û: –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –ø–æ –ø—ñ—Å–Ω—ñ (Inner Table) ---
                    // –¶–µ —Ç–æ–π –∫–æ–¥, —è–∫–æ–≥–æ –Ω–µ –≤–∏—Å—Ç–∞—á–∞–ª–æ –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                    innerTable.setOnMouseClicked(event -> {
                        if (event.getClickCount() == 2 && innerTable.getSelectionModel().getSelectedItem() != null) {
                            Track selectedTrack = innerTable.getSelectionModel().getSelectedItem();
                            if (onPlayTrackFromPlaylist != null) {
                                onPlayTrackFromPlaylist.accept(item, selectedTrack);
                            }
                            event.consume();
                        }
                    });

                    innerTable.setVisible(isExpanded);
                    innerTable.setManaged(isExpanded);
                    setGraphic(root);
                }
            }

            // –î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—Ä–µ–∫—ñ–≤
            private void updateTableVisibility(Playlist item, Label icon, Label arrow) {
                innerTable.setVisible(isExpanded);
                innerTable.setManaged(isExpanded);
                icon.setText(isExpanded ? "üìÇ" : "üìÅ");
                arrow.setText(isExpanded ? "‚ñ≤" : "‚ñº");

                if (isExpanded && trackLoader != null) {
                    List<Track> tracks = trackLoader.apply(item);
                    innerTable.setItems(FXCollections.observableArrayList(tracks));
                }
            }

            // –î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ (—â–æ–± —Å–∫–æ—Ä–æ—Ç–∏—Ç–∏ –∫–æ–¥)
            private Button createIconButton(String svgPath, String colorDefault, String colorHover, Consumer<ActionEvent> action) {
                Button btn = new Button();
                SVGPath icon = new SVGPath();
                icon.setContent(svgPath);
                icon.setFill(Color.web(colorDefault));
                btn.setGraphic(icon);
                btn.setStyle("-fx-background-color: transparent; -fx-cursor: hand; -fx-padding: 0 5 0 5;");
                btn.setOnMouseEntered(e -> icon.setFill(Color.web(colorHover)));
                btn.setOnMouseExited(e -> icon.setFill(Color.web(colorDefault)));
                btn.setOnAction(e -> {
                    action.accept(e);
                    e.consume();
                });
                return btn;
            }
        });

        HBox createBox = new HBox(10);
        createBox.setAlignment(Pos.CENTER);
        createBox.setPadding(new Insets(15));
        createBox.setStyle("-fx-background-color: white; -fx-background-radius: 10; -fx-border-color: #ddd; -fx-border-radius: 10; -fx-border-style: dashed;");

        newPlaylistNameField = new TextField();
        newPlaylistNameField.setPromptText("–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞...");
        HBox.setHgrow(newPlaylistNameField, Priority.ALWAYS);

        createPlaylistBtn = new Button("–°—Ç–≤–æ—Ä–∏—Ç–∏");
        createBox.getChildren().addAll(newPlaylistNameField, createPlaylistBtn);

        box.getChildren().addAll(playlistListView, createBox);
        return box;
    }

    private HBox createControlsBox() {
        HBox box = new HBox(15);
        box.setAlignment(Pos.CENTER);
        box.setPadding(new Insets(15));
        box.setStyle("-fx-background-color: #f0f0f0; -fx-border-color: #ccc;");

        shuffleBtn = new Button("üîÄ");
        prevBtn = new Button("‚èÆ");
        stopBtn = new Button("‚èπ");
        playBtn = new Button("‚ñ∂");
        playBtn.setStyle("-fx-font-weight: bold; -fx-base: #b6e7c9;");
        pauseBtn = new Button("‚è∏");
        nextBtn = new Button("‚è≠");
        repeatBtn = new Button("üîÅ");

        volumeSlider = new Slider(0, 100, 50);

        box.getChildren().addAll(
                shuffleBtn,
                prevBtn,
                stopBtn,
                playBtn,
                pauseBtn,
                nextBtn,
                repeatBtn,
                new Label("Vol:"), volumeSlider);
        return box;
    }

    // --- –î—ñ–∞–ª–æ–≥–æ–≤—ñ –≤—ñ–∫–Ω–∞ ---

    public Track showTrackSelectionDialog(List<Track> allTracks) {
        Dialog<Track> dialog = new Dialog<>();
        dialog.setTitle("–î–æ–¥–∞—Ç–∏ —Ç—Ä–µ–∫ –¥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
        dialog.setHeaderText("–í–∏–±–µ—Ä—ñ—Ç—å —Ç—Ä–µ–∫ –∑—ñ —Å–ø–∏—Å–∫—É");

        dialog.getDialogPane().getButtonTypes().addAll(ButtonType.OK, ButtonType.CANCEL);

        TableView<Track> table = new TableView<>();
        TableColumn<Track, String> colTitle = new TableColumn<>("–ù–∞–∑–≤–∞");
        colTitle.setCellValueFactory(d -> new SimpleStringProperty(d.getValue().getTitle()));

        TableColumn<Track, String> colArtist = new TableColumn<>("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å");
        colArtist.setCellValueFactory(d -> new SimpleStringProperty(d.getValue().getArtist()));

        table.getColumns().addAll(colTitle, colArtist);
        table.setColumnResizePolicy(TableView.CONSTRAINED_RESIZE_POLICY);
        table.setItems(FXCollections.observableArrayList(allTracks));
        table.setPrefHeight(300);
        table.setPrefWidth(400);

        dialog.getDialogPane().setContent(table);

        dialog.setResultConverter(btn -> {
            if (btn == ButtonType.OK) {
                return table.getSelectionModel().getSelectedItem();
            }
            return null;
        });
        return dialog.showAndWait().orElse(null);
    }

    public File showFileChooser() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("–í–∏–±–µ—Ä—ñ—Ç—å –∞—É–¥—ñ–æ—Ñ–∞–π–ª");
        fileChooser.getExtensionFilters().add(new FileChooser.ExtensionFilter("Audio", "*.mp3", "*.wav", "*.flac"));
        return fileChooser.showOpenDialog(root.getScene().getWindow());
    }

    public void showAlert(String title, String content) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(content);
        alert.showAndWait();
    }

    // --- Setters for Callbacks ---

    public void setTrackLoader(Function<Playlist, List<Track>> trackLoader) {
        this.trackLoader = trackLoader;
    }

    public void setOnPlayTrackFromPlaylist(BiConsumer<Playlist, Track> onPlayTrackFromPlaylist) {
        this.onPlayTrackFromPlaylist = onPlayTrackFromPlaylist;
    }

    public void setOnAddTrackToPlaylist(Consumer<Playlist> onAddTrackToPlaylist) {
        this.onAddTrackToPlaylist = onAddTrackToPlaylist;
    }

    public void setOnEditPlaylist(Consumer<Playlist> onEditPlaylist) {
        this.onEditPlaylist = onEditPlaylist;
    }

    public void setOnDeletePlaylist(Consumer<Playlist> onDeletePlaylist) {
        this.onDeletePlaylist = onDeletePlaylist;
    }

    public void setDurationCalculator(Function<Playlist, String> durationCalculator) {
        this.durationCalculator = durationCalculator;
    }

    // --- Getters ---

    public TableView<Track> getLibraryTable() { return libraryTable; }
    public ListView<Playlist> getPlaylistListView() { return playlistListView; }
    public Label getStatusLabel() { return statusLabel; }
    public Label getCurrentTrackLabel() { return currentTrackLabel; }
    public Slider getVolumeSlider() { return volumeSlider; }
    public TextField getNewPlaylistNameField() { return newPlaylistNameField; }

    public Button getPlayBtn() { return playBtn; }
    public Button getPauseBtn() { return pauseBtn; }
    public Button getStopBtn() { return stopBtn; }
    public Button getNextBtn() { return nextBtn; }
    public Button getPrevBtn() { return prevBtn; }
    public Button getRefreshBtn() { return refreshBtn; }
    public Button getPlayLibraryBtn() { return playLibraryBtn; }
    public Button getAddFileBtn() { return addFileBtn; }
    public Button getAddToPlaylistBtn() { return addToPlaylistBtn; }
    public Button getCreatePlaylistBtn() { return createPlaylistBtn; }
    public Button getPlayPlaylistBtn() { return playPlaylistBtn; }
    public Button getRepeatBtn() { return repeatBtn; }
    public Button getShuffleBtn() { return shuffleBtn; }

    public Button getLoginBtn() { return loginBtn; }
    public Button getRegisterBtn() { return registerBtn; }
    public Button getLogoutBtn() { return logoutBtn; }
}

package com.example.labs.client;

import com.example.labs.common.model.MusicPlayer;
import com.example.labs.common.NetworkRequest;
import com.example.labs.common.NetworkResponse;
import com.example.labs.common.model.*;
import com.example.labs.common.patterns.memento.PlayerMemento;
import com.example.labs.server.service.*;

import java.util.List;

public class MusicSystemFacade {
    private final MusicPlayer musicPlayer;
    private final UserService userService;
    private final TrackService trackService;
    private final PlaylistService playlistService;
    private final NetworkClient netClient;

    public MusicSystemFacade() {
        this.netClient = new NetworkClient();

        // --- 1. PROXY USER SERVICE ---
        this.userService = new UserService(null) {
            @Override
            public User login(String email, String password) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("LOGIN", new String[]{email, password}));
                return resp.isSuccess() ? (User) resp.getData() : null;
            }

            @Override
            public User register(String name, String email, String password) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("REGISTER", new String[]{name, email, password}));
                return resp.isSuccess() ? (User) resp.getData() : null;
            }

            // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ü–û–ú–ò–õ–ö–ò: –î–æ–¥–∞–Ω–æ —Ü–µ–π –º–µ—Ç–æ–¥ ---
            @Override
            public User getUserByID(int id) {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–º—ñ—Å—Ç—å –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó –ë–î (—è–∫–æ—ó –Ω–µ–º–∞—î)
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("GET_USER", id));
                return resp.isSuccess() ? (User) resp.getData() : null;
            }
        };

        // --- 2. PROXY TRACK SERVICE ---
        this.trackService = new TrackService(null) {
            @Override
            public List<Track> getAllTracks(int userId) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("GET_USER_TRACKS", userId));
                return resp.isSuccess() ? (List<Track>) resp.getData() : List.of();
            }

            @Override
            public void addTrack(Track track) {
                netClient.sendRequest(new NetworkRequest("ADD_TRACK", track));
            }

            @Override
            public void updateTrack(Track track) {
                netClient.sendRequest(new NetworkRequest("UPDATE_TRACK", track));
            }

            @Override
            public void deleteTrack(int id) {
                netClient.sendRequest(new NetworkRequest("DELETE_TRACK", id));
            }

            @Override
            public Track getTrackByID(int id) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("GET_TRACK", id));
                return resp.isSuccess() ? (Track) resp.getData() : null;
            }

            @Override
            public void linkTrackToUser(int userId, int trackId) {
                netClient.sendRequest(new NetworkRequest("LINK_TRACK_USER", new int[]{userId, trackId}));
            }
        };

        // --- 3. PROXY PLAYLIST SERVICE ---
        this.playlistService = new PlaylistService(null) {
            @Override
            public List<Playlist> getAllPlaylists(int userId) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("GET_USER_PLAYLISTS", userId));
                return resp.isSuccess() ? (List<Playlist>) resp.getData() : List.of();
            }

            @Override
            public Playlist createPlaylist(Playlist playlist) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("CREATE_PLAYLIST", playlist));
                return resp.isSuccess() ? (Playlist) resp.getData() : null;
            }

            @Override
            public void updatePlaylist(Playlist playlist) {
                netClient.sendRequest(new NetworkRequest("UPDATE_PLAYLIST", playlist));
            }

            @Override
            public void deletePlaylist(int id) {
                netClient.sendRequest(new NetworkRequest("DELETE_PLAYLIST", id));
            }

            @Override
            public void linkPlaylistToUser(int userId, int playlistId) {
                netClient.sendRequest(new NetworkRequest("LINK_PLAYLIST_USER", new int[]{userId, playlistId}));
            }

            @Override
            public Playlist getPlaylistByID(int id) {
                NetworkResponse resp = netClient.sendRequest(new NetworkRequest("GET_PLAYLIST", id));
                return resp.isSuccess() ? (Playlist) resp.getData() : null;
            }
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–µ—î—Ä–∞ –∑ –ø—Ä–æ–∫—Å—ñ-—Å–µ—Ä–≤—ñ—Å–∞–º–∏
        this.musicPlayer = new MusicPlayer(userService, trackService, playlistService);

        // –¢–µ–ø–µ—Ä —Ü–µ–π –≤–∏–∫–ª–∏–∫ —Å–ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ, –±–æ –≤—ñ–Ω –ø—ñ–¥–µ —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É
        User defaultUser = userService.getUserByID(1);
        if (defaultUser != null) this.musicPlayer.loginUser(1);
    }

    public MusicPlayer getPlayer() { return musicPlayer; }
    public UserService getUserService() { return userService; }
    public TrackService getTrackService() { return trackService; }
    public PlaylistService getPlaylistService() { return playlistService; }

    public User authenticate(String email, String password) {
        User user = userService.login(email, password);
        if (user != null) musicPlayer.loginUser(user.getUserID());
        return user;
    }

    public User register(String name, String email, String password) {
        User user = userService.register(name, email, password);
        if (user != null) musicPlayer.loginUser(user.getUserID());
        return user;
    }

    public void logout() {
        musicPlayer.stop(); // –ó—É–ø–∏–Ω—è—î–º–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
        User defaultUser = userService.getUserByID(1);
        if (defaultUser != null) {
            musicPlayer.loginUser(defaultUser.getUserID());
        }
    }

    public List<Track> getCurrentUserTracks() {
        if (musicPlayer.getCurrentUser() == null) return List.of();
        return trackService.getAllTracks(musicPlayer.getCurrentUser().getUserID());
    }

    public List<Playlist> getCurrentUserPlaylists() {
        if (musicPlayer.getCurrentUser() == null) return List.of();
        return playlistService.getAllPlaylists(musicPlayer.getCurrentUser().getUserID());
    }

    public void addTrackToLibrary(Track track) {

        if (musicPlayer.getCurrentUser() != null) {
            int userId = musicPlayer.getCurrentUser().getUserID();
            netClient.sendRequest(new NetworkRequest("ADD_TRACK", new Object[]{userId, track}));
        }
    }

    public void saveState(int userId, PlayerMemento memento) {
        // –ü–µ—Ä–µ–¥–∞—î–º–æ –º–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤, —è–∫ –æ—á—ñ–∫—É—î —Å–µ—Ä–≤–µ—Ä (ClientHandler —Ä—è–¥–æ–∫ 888)
        netClient.sendRequest(new NetworkRequest("SAVE_STATE", new Object[]{userId, memento}));
    }

    public PlayerMemento loadState(int userId) {
        NetworkResponse resp = netClient.sendRequest(new NetworkRequest("LOAD_STATE", userId));
        return resp.isSuccess() ? (PlayerMemento) resp.getData() : null;
    }
}

package com.example.labs.client;

import com.example.labs.common.NetworkRequest;
import com.example.labs.common.NetworkResponse;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;

public class NetworkClient {
    private static final String SERVER_HOST = "localhost";
    private static final int SERVER_PORT = 8888;

    public NetworkResponse sendRequest(NetworkRequest request) {
        try (Socket socket = new Socket(SERVER_HOST, SERVER_PORT);
             ObjectOutputStream out = new ObjectOutputStream(socket.getOutputStream());
             ObjectInputStream in = new ObjectInputStream(socket.getInputStream())) {

            out.writeObject(request);
            return (NetworkResponse) in.readObject();

        } catch (Exception e) {
            e.printStackTrace();
            return new NetworkResponse(false, "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e.getMessage());
        }
    }
}

package com.example.labs.common.model;

import com.example.labs.common.patterns.iterator.*;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class Library implements Playable {
    private List<Track> tracks;

    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∏–π —ñ—Ç–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±'—î–∫—Ç—ñ–≤ Track
    private AudioIterator<Track> iterator;

    private boolean isShuffle = false;
    private boolean isPlaying = false;

    public Library() {
        this.tracks = new ArrayList<>();
        // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –ª—ñ–Ω—ñ–π–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫
        this.iterator = new LinearIterator<>(this.tracks);
    }

    public void addTrack(Track track) {
        if (track != null && !tracks.contains(track)) {
            tracks.add(track);
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä, —â–æ–± –≤—ñ–Ω –≤—Ä–∞—Ö—É–≤–∞–≤ –Ω–æ–≤—ñ –¥–∞–Ω—ñ
            updateIterator();
        }
    }

    public void removeTrack(Track track) {
        tracks.remove(track);
        updateIterator();
    }

    /**
     * –§–∞–±—Ä–∏—á–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –æ–±—Ö–æ–¥—É.
     * –¢—É—Ç –ª–∏—à–µ Linear –∞–±–æ Shuffle, –±–µ–∑ Repeat.
     */
    private void updateIterator() {
        if (isShuffle) {
            this.iterator = new ShuffleIterator<>(this.tracks);
        } else {
            this.iterator = new LinearIterator<>(this.tracks);
        }
    }

    @Override
    public void play() {
        if (!tracks.isEmpty()) {
            isPlaying = true;
        }
    }

    @Override
    public void pause() {
        isPlaying = false;
    }

    @Override
    public void stop() {
        isPlaying = false;
        updateIterator();
    }

    @Override
    public int next() {
        if (iterator.hasNext()) {
            Track t = iterator.next();
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ ID, –æ—Å–∫—ñ–ª—å–∫–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å Playable –≤–∏–º–∞–≥–∞—î int
            return t != null ? t.getTrackID() : -1;
        }
        return -1;
    }

    @Override
    public int previous() {
        if (iterator.hasPrevious()) {
            Track t = iterator.previous();
            return t != null ? t.getTrackID() : -1;
        }
        return -1;
    }

    @Override
    public void setShuffle(boolean enable) {
        if (this.isShuffle != enable) {
            this.isShuffle = enable;
            updateIterator(); // –ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É –∑–º—ñ–Ω—é—î —Ç–∏–ø —ñ—Ç–µ—Ä–∞—Ç–æ—Ä–∞
        }
    }

    @Override
    public boolean isShuffle() {
        return isShuffle;
    }

    @Override
    public List<Integer> getTracks() {
        return tracks.stream()
                .map(Track::getTrackID)
                .collect(Collectors.toList());
    }

    public List<Track> getFullTrackList() {
        return new ArrayList<>(tracks);
    }

    @Override
    public void setCurrentTrack(int trackId) {
        // –®—É–∫–∞—î–º–æ —Ç—Ä–µ–∫ —É —Å–ø–∏—Å–∫—É –∑–∞ ID
        Track foundTrack = tracks.stream()
                .filter(t -> t.getTrackID() == trackId)
                .findFirst()
                .orElse(null);

        if (foundTrack != null) {
            iterator.setCursor(foundTrack);
        }
    }
}

package com.example.labs.common.model;

import com.example.labs.client.AudioConverter;
import com.example.labs.common.patterns.memento.PlayerMemento;
import com.example.labs.server.service.PlaylistService;
import com.example.labs.server.service.TrackService;
import com.example.labs.server.service.UserService;
import javafx.scene.media.Media;
import javafx.scene.media.MediaPlayer;

public class MusicPlayer {
    private int volume;
    private boolean isPlaying;
    private boolean isRepeat;

    private Playable currentPlayable;
    private Track currentTrack;
    private User currentUser;
    private double startAtTime = 0.0;
    private Runnable onTrackChanged;

    // 2. –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –º–µ—Ç–æ–¥ (—Å–µ—Ç—Ç–µ—Ä) –¥–µ—Å—å –≤–Ω–∏–∑—É –∫–ª–∞—Å—É
    public void setOnTrackChanged(Runnable callback) {
        this.onTrackChanged = callback;
    }

    // --- –ù–û–í–ï –ü–û–õ–ï ---
    private MediaPlayer mediaPlayer;

    private UserService userService;
    private TrackService trackService;
    private PlaylistService playlistService;

    public MusicPlayer(UserService userService, TrackService trackService, PlaylistService playlistService) {
        this.userService = userService;
        this.trackService = trackService;
        this.playlistService = playlistService;
        this.volume = 50;
        this.isPlaying = false;
    }

    public void play() {
        if (currentPlayable == null) {
            return;
        }

        if (currentTrack == null) {
            loadNextValidTrack();
        }

        if (currentTrack != null) {
            this.isPlaying = true;
            currentPlayable.play();

            if (mediaPlayer != null) {
                mediaPlayer.play();
            } else {
                playCurrentTrackInternal();
            }

            if (onTrackChanged != null) {
                onTrackChanged.run();
            }

        } else {
            stop();
        }
    }

    private void loadNextValidTrack() {
        int trackId = currentPlayable.next();
        while (trackId != -1) {
            Track trackFromLibrary = trackService.getTrackByID(trackId);
            if (trackFromLibrary != null) {
                this.currentTrack = trackFromLibrary;
                return;
            } else {
                trackId = currentPlayable.next();
            }
        }
        this.currentTrack = null;
    }

    public void pause() {
        if (isPlaying) {
            this.isPlaying = false;
            if (currentPlayable != null) currentPlayable.pause();

            if (mediaPlayer != null) {
                mediaPlayer.pause();
            }
        }
    }

    private boolean isShuffleGlobal = false; // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –ø–ª–µ—î—Ä–∞

    public void setShuffle(boolean enable) {
        this.isShuffleGlobal = enable;
        if (currentPlayable != null) {
            currentPlayable.setShuffle(enable);
        }
    }

    public boolean isShuffle() {
        return isShuffleGlobal;
    }

    public void setPlayableSource(Playable playable) {
        this.currentPlayable = playable;
        if (this.currentPlayable != null) {
            this.currentPlayable.setShuffle(isShuffleGlobal);
        }
        stop();
    }

    public boolean isRepeat() {
        return isRepeat;
    }

    public void stop() {
        this.isPlaying = false;
        this.currentTrack = null;
        if (currentPlayable != null) currentPlayable.stop();

        if (mediaPlayer != null) {
            mediaPlayer.stop();
            mediaPlayer.dispose(); // –û—á–∏—â–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ
            mediaPlayer = null;
        }
    }

    public void next() {
        if (currentPlayable != null) {
            loadNextValidTrack();
            if (currentTrack != null) {

                if (mediaPlayer != null) {
                    mediaPlayer.stop();
                    mediaPlayer.dispose();
                    mediaPlayer = null;
                }
                play();
            } else {
                if (isRepeat) {
                    currentPlayable.stop();
                    play();
                } else {
                    stop();
                }
            }
        }
    }

    public void previous() {
        if (currentPlayable != null) {
            int prevId = currentPlayable.previous();
            if (prevId != -1) {
                this.currentTrack = trackService.getTrackByID(prevId);

                if (mediaPlayer != null) {
                    mediaPlayer.stop();
                    mediaPlayer.dispose();
                    mediaPlayer = null;
                }
                if (currentPlayable != null) {
                    currentPlayable.setCurrentTrack(this.currentTrack.getTrackID());
                }

                play();
            }
        }
    }

    public void setVolume(int volume) {
        this.volume = volume;
        if (mediaPlayer != null) {
            mediaPlayer.setVolume(volume / 100.0);
        }
    }

    public Track getCurrentTrack() {
        return currentTrack;
    }

    public void toggleRepeat() {
        this.isRepeat = !this.isRepeat;
    }

    public void playTrack(Track track) {
        stop();
        this.currentTrack = track;

        // –í–ê–ñ–õ–ò–í–û: –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä –∑ –æ–±—Ä–∞–Ω–∏–º —Ç—Ä–µ–∫–æ–º
        if (currentPlayable != null) {
            currentPlayable.setCurrentTrack(track.getTrackID());
        }

        play();
    }

    public boolean isPlaying() { return isPlaying; }
    public User getCurrentUser() { return currentUser; }
    public void loginUser(int userId) { this.currentUser = userService.getUserByID(userId); }


    private void playCurrentTrackInternal() {
        if (mediaPlayer != null) {
            mediaPlayer.stop();
            mediaPlayer.dispose();
        }

        try {
            // --- –ó–ú–Ü–ù–ê –ü–û–ß–ò–ù–ê–Ñ–¢–¨–°–Ø –¢–£–¢ ---
            // –û—Ç—Ä–∏–º—É—î–º–æ URI —á–µ—Ä–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä. –Ø–∫—â–æ —Ü–µ FLAC, –æ—Ç—Ä–∏–º–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ temp.wav
            String mediaSource = AudioConverter.getPlayableURI(currentTrack.getFilePath());

            if (mediaSource == null) {
                System.err.println("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª: " + currentTrack.getFilePath());
                next(); // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –±–∏—Ç–∏–π —Ñ–∞–π–ª
                return;
            }

            Media media = new Media(mediaSource);
            // --- –ó–ú–Ü–ù–ê –ó–ê–ö–Ü–ù–ß–£–Ñ–¢–¨–°–Ø –¢–£–¢ ---

            mediaPlayer = new MediaPlayer(media);
            mediaPlayer.setVolume(this.volume / 100.0);

            mediaPlayer.setOnReady(() -> {
                if (startAtTime > 0) {
                    mediaPlayer.seek(javafx.util.Duration.seconds(startAtTime));
                    startAtTime = 0;
                }
            });

            mediaPlayer.setOnEndOfMedia(() -> {
                if (isRepeat) {
                    mediaPlayer.seek(javafx.util.Duration.ZERO);
                    mediaPlayer.play();
                } else {
                    next();
                }
            });

            mediaPlayer.play();

        } catch (Exception e) {
            e.printStackTrace();
            next(); // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ç—Ä–µ–∫ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        }
    }

    // 3. –û–Ω–æ–≤—ñ—Ç—å saveState
    public PlayerMemento saveState() {
        int trackId = (currentTrack != null) ? currentTrack.getTrackID() : -1;

        int sourceType = 0;
        int sourceId = 0;
        if (currentPlayable instanceof Playlist) {
            sourceType = 1;
            sourceId = ((Playlist) currentPlayable).getPlaylistID();
        }

        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –ø–ª–µ—î—Ä–∞
        double currentTime = 0.0;
        if (mediaPlayer != null) {
            currentTime = mediaPlayer.getCurrentTime().toSeconds();
        }

        return new PlayerMemento(this.volume, this.isShuffleGlobal, this.isRepeat, trackId, sourceType, sourceId, currentTime);
    }

    // 4. –û–Ω–æ–≤—ñ—Ç—å restoreState
    public void restoreState(PlayerMemento memento) {
        if (memento == null) return;

        this.setVolume(memento.getVolume());
        this.setShuffle(memento.isShuffle());
        if (this.isRepeat != memento.isRepeat()) this.toggleRepeat();

        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –¥–∂–µ—Ä–µ–ª–æ (Playlist –∞–±–æ Library)
        if (memento.getSourceType() == 1) {
            Playlist pl = playlistService.getPlaylistByID(memento.getSourceId());
            if (pl != null) this.setPlayableSource(pl);
        } else {
            Library lib = new Library();
            if (currentUser != null) {
                trackService.getAllTracks(currentUser.getUserID()).forEach(lib::addTrack);
            }
            this.setPlayableSource(lib);
        }

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å, –∑ —è–∫–æ–≥–æ —Ç—Ä–µ–±–∞ –ø–æ—á–∞—Ç–∏
        this.startAtTime = memento.getCurrentTime();

        if (memento.getCurrentTrackId() != -1) {
            Track t = trackService.getTrackByID(memento.getCurrentTrackId());
            if (t != null) {
                this.playTrack(t);
                this.pause(); // –°—Ç–∞–≤–∏–º–æ –Ω–∞ –ø–∞—É–∑—É, —â–æ–± –Ω–µ –≥—Ä–∞–ª–æ —Å–∞–º–æ, –∞–ª–µ —á–∞—Å –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —É startAtTime
            }
        }
    }
}

package com.example.labs.common.model;

import java.util.List;

public interface Playable {
    void play();
    void pause();
    void stop();
    int next();
    int previous();
    void setShuffle(boolean enable);
    boolean isShuffle();
    List<Integer> getTracks();
    void setCurrentTrack(int trackId);
}

package com.example.labs.common.model;

import com.example.labs.common.patterns.iterator.*;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

public class Playlist implements Playable, Serializable {

    private int playlistID;
    private String name;
    // –ó–±–µ—Ä—ñ–≥–∞—î ID —Ç—Ä–µ–∫—ñ–≤
    private List<Integer> trackList;

    // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø 1: –î–æ–¥–∞–Ω–æ transient ---
    // –¶–µ –ø–æ–ª–µ –Ω–µ –±—É–¥–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É
    private transient AudioIterator<Integer> iterator;

    private boolean isShuffle = false;
    private boolean isPlaying = false;

    public Playlist(int playlistID, String name) {
        this.playlistID = playlistID;
        this.name = name;
        this.trackList = new ArrayList<>();

        // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –ª—ñ–Ω—ñ–π–Ω–∏–π —ñ—Ç–µ—Ä–∞—Ç–æ—Ä
        this.iterator = new LinearIterator<>(this.trackList);
    }

    // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø 2: –ú–µ—Ç–æ–¥ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó ---
    private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException {
        in.defaultReadObject(); // –ß–∏—Ç–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –ø–æ–ª—è (ID, name, trackList)
        updateIterator();       // –°—Ç–≤–æ—Ä—é—î–º–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä –Ω–∞–Ω–æ–≤–æ
    }

    public void addTrack(int trackID) {
        trackList.add(trackID);
        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä, —â–æ–± –≤—ñ–Ω –≤—Ä–∞—Ö—É–≤–∞–≤ –Ω–æ–≤–∏–π —Ç—Ä–µ–∫
        updateIterator();
    }

    public void removeTrack(int trackID) {
        // –í–∏–¥–∞–ª—è—î–º–æ –æ–±'—î–∫—Ç (ID), –∞ –Ω–µ –∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º
        trackList.remove(Integer.valueOf(trackID));
        updateIterator();
    }

    /**
     * –û–Ω–æ–≤–ª—é—î —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é –æ–±—Ö–æ–¥—É —Å–ø–∏—Å–∫—É.
     * –í–∏–±—ñ—Ä –ª–∏—à–µ –º—ñ–∂ Shuffle —Ç–∞ Linear (–±–µ–∑ Repeat).
     */
    private void updateIterator() {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ null –ø–æ—Ç—Ä—ñ–±–Ω–∞, —è–∫—â–æ –º–µ—Ç–æ–¥ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ readObject –¥–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–ø–∏—Å–∫—É (—Ö–æ—á–∞ defaultReadObject —Ü–µ —Ä–æ–±–∏—Ç—å)
        if (this.trackList == null) this.trackList = new ArrayList<>();

        if (isShuffle) {
            this.iterator = new ShuffleIterator<>(this.trackList);
        } else {
            this.iterator = new LinearIterator<>(this.trackList);
        }
    }

    @Override
    public void play() {
        if (!trackList.isEmpty()) {
            isPlaying = true;
        }
    }

    @Override
    public void pause() {
        isPlaying = false;
    }

    @Override
    public void stop() {
        isPlaying = false;
        // –°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó (–ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Ç–µ—Ä–∞—Ç–æ—Ä–∞)
        updateIterator();
    }

    @Override
    public int next() {
        if (iterator != null && iterator.hasNext()) {
            return iterator.next();
            // –ü–æ–≤–µ—Ä—Ç–∞—î Integer (ID)
        }
        return -1;
    }

    @Override
    public int previous() {
        if (iterator != null && iterator.hasPrevious()) {
            return iterator.previous();
            // –ü–æ–≤–µ—Ä—Ç–∞—î Integer (ID)
        }
        return -1;
    }

    @Override
    public void setShuffle(boolean enable) {
        if (this.isShuffle != enable) {
            this.isShuffle = enable;
            updateIterator(); // –ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É –∑–º—ñ–Ω—é—î —Ç–∏–ø —ñ—Ç–µ—Ä–∞—Ç–æ—Ä–∞
        }
    }

    @Override
    public boolean isShuffle() {
        return isShuffle;
    }

    @Override
    public List<Integer> getTracks() {
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ–ø—ñ—é —Å–ø–∏—Å–∫—É –¥–ª—è –±–µ–∑–ø–µ–∫–∏
        return new ArrayList<>(trackList);
    }

    // --- –ì–µ—Ç—Ç–µ—Ä–∏ —Ç–∞ –°–µ—Ç—Ç–µ—Ä–∏ ---

    public int getPlaylistID() {
        return playlistID;
    }

    public void setPlaylistID(int playlistID) {
        this.playlistID = playlistID;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return name;
    }

    @Override
    public void setCurrentTrack(int trackId) {
        // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—î–º–æ ID, –±–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π —è–∫ Integer
        if (iterator == null) updateIterator();
        iterator.setCursor(trackId);
    }
}

package com.example.labs.common.model;

import com.example.labs.common.patterns.visitor.Visitable;
import com.example.labs.common.patterns.visitor.Visitor;

import java.io.Serializable;
import java.util.Objects;

public class Track implements Visitable, Serializable {

    private int trackID;
    private String title;
    private String artist;
    private String album;
    private double duration; // –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —É —Å–µ–∫—É–Ω–¥–∞—Ö –∞–±–æ —Ö–≤–∏–ª–∏–Ω–∞—Ö (–∑–≥—ñ–¥–Ω–æ –∑ –¥—ñ–∞–≥—Ä–∞–º–æ—é —Ç–∏–ø double)
    private String filePath;

    public Track() {
    }

    public Track(int trackID, String title, String artist, String album, double duration, String filePath) {
        this.trackID = trackID;
        this.title = title;
        this.artist = artist;
        this.album = album;
        this.duration = duration;
        this.filePath = filePath;
    }


    public int getTrackID() {
        return trackID;
    }

    public void setTrackID(int trackID) {
        this.trackID = trackID;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getArtist() {
        return artist;
    }

    public void setArtist(String artist) {
        this.artist = artist;
    }

    public String getAlbum() {
        return album;
    }

    public void setAlbum(String album) {
        this.album = album;
    }

    public double getDuration() {
        return duration;
    }

    public void setDuration(double duration) {
        this.duration = duration;
    }

    public String getFilePath() {
        return filePath;
    }

    public void setFilePath(String filePath) {
        this.filePath = filePath;
    }

    @Override
    public String toString() {
        return "Track{" +
                "id=" + trackID +
                ", title='" + title + '\'' +
                ", artist='" + artist + '\'' +
                ", album='" + album + '\'' +
                ", duration=" + duration +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Track track = (Track) o;
        return trackID == track.trackID;
    }

    @Override
    public int hashCode() {
        return Objects.hash(trackID);
    }

    @Override
    public void accept(Visitor visitor) {
        visitor.visitTrack(this);
    }
}

package com.example.labs.common.model;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

public class User implements Serializable {

    private int userID;
    private String name;
    private String email;
    private String password;
    // settings –≤–∏–¥–∞–ª–µ–Ω–æ

    private List<Playlist> playlists;

    public User() {
        this.playlists = new ArrayList<>();
    }

    // –û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–µ–∑ settings
    public User(int userID, String name, String email, String password) {
        this.userID = userID;
        this.name = name;
        this.email = email;
        this.password = password;
        this.playlists = new ArrayList<>();
    }

    public int getUserID() { return userID; }
    public void setUserID(int userID) { this.userID = userID; }

    public String getName() { return name; }
    public void setName(String name) { this.name = name; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }

    public List<Playlist> getPlaylists() { return playlists; }
    public void setPlaylists(List<Playlist> playlists) { this.playlists = playlists; }

    @Override
    public String toString() {
        return name;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return userID == user.userID;
    }

    @Override
    public int hashCode() {
        return Objects.hash(userID);
    }
}

package com.example.labs.common;

import java.io.Serializable;

public class NetworkRequest implements Serializable {
    // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó (–≥–∞—Ä–∞–Ω—Ç—É—î —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –≤–µ—Ä—Å—ñ–π)
    private static final long serialVersionUID = 1L;

    private String command; // –ù–∞–∑–≤–∞ –∫–æ–º–∞–Ω–¥–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "LOGIN", "ADD_TRACK"
    private Object payload; // –ë—É–¥—å-—è–∫—ñ –¥–∞–Ω—ñ (User, Track, String[], Integer —Ç–æ—â–æ)

    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ—Ä–æ–∂–Ω—ñ–π (—ñ–Ω–æ–¥—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
    public NetworkRequest() {
    }

    // –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    public NetworkRequest(String command, Object payload) {
        this.command = command;
        this.payload = payload;
    }

    public String getCommand() {
        return command;
    }

    public void setCommand(String command) {
        this.command = command;
    }

    public Object getPayload() {
        return payload;
    }

    public void setPayload(Object payload) {
        this.payload = payload;
    }

    @Override
    public String toString() {
        return "NetworkRequest{" +
                "command='" + command + '\'' +
                ", payload=" + payload +
                '}';
    }
}

package com.example.labs.common;

import java.io.Serializable;

public class NetworkResponse implements Serializable {
    private static final long serialVersionUID = 1L;

    private boolean success;      // –ß–∏ —É—Å–ø—ñ—à–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è?
    private Object data;          // –î–∞–Ω—ñ, —è–∫—ñ –ø–æ–≤–µ—Ä—Ç–∞—î —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, User –∞–±–æ List<Track>)
    private String errorMessage;  // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫—â–æ success = false

    public NetworkResponse() {
    }

    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    public NetworkResponse(boolean success, Object data) {
        this.success = success;
        this.data = data;
        this.errorMessage = null;
    }

    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è –ø–æ–º–∏–ª–∫–∏ (–∑—Ä—É—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏)
    public NetworkResponse(boolean success, String errorMessage) {
        this.success = success;
        this.data = null;
        this.errorMessage = errorMessage;
    }

    // –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    public NetworkResponse(boolean success, Object data, String errorMessage) {
        this.success = success;
        this.data = data;
        this.errorMessage = errorMessage;
    }

    public boolean isSuccess() {
        return success;
    }

    public void setSuccess(boolean success) {
        this.success = success;
    }

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

    public String getErrorMessage() {
        return errorMessage;
    }

    public void setErrorMessage(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    @Override
    public String toString() {
        return "NetworkResponse{" +
                "success=" + success +
                ", data=" + data +
                ", errorMessage='" + errorMessage + '\'' +
                '}';
    }
}

package com.example.labs.common.patterns.command;

public interface Command {
    void execute();
}

package com.example.labs.common.patterns.command;

import com.example.labs.common.model.MusicPlayer;

public class NextCommand implements Command {
    private MusicPlayer musicPlayer;

    public NextCommand(MusicPlayer musicPlayer) {
        this.musicPlayer = musicPlayer;
    }

    @Override
    public void execute() {
        musicPlayer.next();
    }
}


package com.example.labs.common.patterns.command;

import com.example.labs.common.model.MusicPlayer;

public class PauseCommand implements Command {
    private MusicPlayer musicPlayer;

    public PauseCommand(MusicPlayer musicPlayer) {
        this.musicPlayer = musicPlayer;
    }

    @Override
    public void execute() {
        musicPlayer.pause();
    }
}


package com.example.labs.common.patterns.command;

import com.example.labs.common.model.MusicPlayer;

public class PlayCommand implements Command {
    private MusicPlayer musicPlayer;

    public PlayCommand(MusicPlayer musicPlayer) {
        this.musicPlayer = musicPlayer;
    }

    @Override
    public void execute() {
        musicPlayer.play();
    }
}

package com.example.labs.common.patterns.command;

import com.example.labs.common.model.MusicPlayer;

public class PreviousCommand implements Command {
    private MusicPlayer musicPlayer;

    public PreviousCommand(MusicPlayer musicPlayer) {
        this.musicPlayer = musicPlayer;
    }

    @Override
    public void execute() {
        musicPlayer.previous();
    }
}


package com.example.labs.common.patterns.command;

import com.example.labs.common.model.MusicPlayer;

public class StopCommand implements Command {
    private MusicPlayer musicPlayer;

    public StopCommand(MusicPlayer musicPlayer) {
        this.musicPlayer = musicPlayer;
    }

    @Override
    public void execute() {
        musicPlayer.stop();
    }
}

package com.example.labs.common.patterns.iterator;

public interface AudioIterator<T> {
    boolean hasNext();
    T next();
    boolean hasPrevious();
    T previous();
    void setCursor(T element);
}


package com.example.labs.common.patterns.iterator;

import java.util.List;

public class LinearIterator<T> implements AudioIterator<T> {
    private List<T> list;
    private int index = -1;

    public LinearIterator(List<T> list) {
        this.list = list;
    }

    @Override
    public boolean hasNext() {
        return !list.isEmpty() && index < list.size() - 1;
    }

    @Override
    public T next() {
        if (!hasNext()) return null;
        index++;
        return list.get(index);
    }

    @Override
    public boolean hasPrevious() {
        return !list.isEmpty() && index > 0;
    }

    @Override
    public T previous() {
        if (!hasPrevious()) return null;
        index--;
        return list.get(index);
    }

    @Override
    public void setCursor(T element) {
        this.index = list.indexOf(element);
    }
}


package com.example.labs.common.patterns.iterator;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class ShuffleIterator<T> implements AudioIterator<T> {
    private List<T> shuffledTracks;
    private int currentPosition = -1;

    public ShuffleIterator(List<T> originalTracks) {
        this.shuffledTracks = new ArrayList<>(originalTracks);
        Collections.shuffle(this.shuffledTracks);
    }

    @Override
    public boolean hasNext() {
        return !shuffledTracks.isEmpty() && currentPosition < shuffledTracks.size() - 1;
    }

    @Override
    public T next() {
        if (hasNext()) {
            currentPosition++;
            return shuffledTracks.get(currentPosition);
        }
        return null;
    }

    @Override
    public boolean hasPrevious() {
        return !shuffledTracks.isEmpty() && currentPosition > 0;
    }

    @Override
    public T previous() {
        if (hasPrevious()) {
            currentPosition--;
            return shuffledTracks.get(currentPosition);
        }
        return null;
    }

    @Override
    public void setCursor(T element) {
        this.currentPosition = shuffledTracks.indexOf(element);
    }
}

package com.example.labs.common.patterns.memento;

import java.util.Stack;

public class Caretaker {
    private final Stack<PlayerMemento> history = new Stack<>();

    public void save(PlayerMemento memento) {
        history.push(memento);
    }

    public PlayerMemento undo() {
        if (!history.isEmpty()) {
            return history.pop();
        }
        return null;
    }

    public boolean hasHistory() {
        return !history.isEmpty();
    }
}

package com.example.labs.common.patterns.memento;

import java.io.Serializable;

public class PlayerMemento implements Serializable {
    private static final long serialVersionUID = 1L; // <--- –ë–∞–∂–∞–Ω–æ –¥–æ–¥–∞—Ç–∏ ID –≤–µ—Ä—Å—ñ—ó

    private final int volume;
    private final boolean isShuffle;
    private final boolean isRepeat;
    private final int currentTrackId;
    private final int sourceType;
    private final int sourceId;
    private final double currentTime;

    public PlayerMemento(int volume, boolean isShuffle, boolean isRepeat, int currentTrackId, int sourceType, int sourceId, double currentTime) {
        this.volume = volume;
        this.isShuffle = isShuffle;
        this.isRepeat = isRepeat;
        this.currentTrackId = currentTrackId;
        this.sourceType = sourceType;
        this.sourceId = sourceId;
        this.currentTime = currentTime;
    }

    public int getVolume() { return volume; }
    public boolean isShuffle() { return isShuffle; }
    public boolean isRepeat() { return isRepeat; }
    public int getCurrentTrackId() { return currentTrackId; }
    public int getSourceType() { return sourceType; }
    public int getSourceId() { return sourceId; }

    public double getCurrentTime() { return currentTime; } // <-- –ù–û–í–ò–ô –ì–ï–¢–¢–ï–†
}

package com.example.labs.common.patterns.visitor;

import com.example.labs.common.model.Track;

public class DurationVisitor implements Visitor {
    private double totalDurationInSeconds = 0;
    private int trackCount = 0;

    @Override
    public void visitTrack(Track track) {
        if (track != null) {
            totalDurationInSeconds += track.getDuration();
            trackCount++;
        }
    }

    public double getTotalDurationInSeconds() {
        return totalDurationInSeconds;
    }

    public String getFormattedDuration() {
        int hours = (int) (totalDurationInSeconds / 3600);
        int remainder = (int) (totalDurationInSeconds % 3600);
        int minutes = remainder / 60;
        int seconds = remainder % 60;

        if (hours > 0) {
            return String.format("%d –≥–æ–¥ %d —Ö–≤ %d —Å–µ–∫", hours, minutes, seconds);
        } else {
            return String.format("%d —Ö–≤ %d —Å–µ–∫", minutes, seconds);
        }
    }

    public int getTrackCount() {
        return trackCount;
    }
}

package com.example.labs.common.patterns.visitor;

public interface Visitable {
    void accept(Visitor visitor);
}

package com.example.labs.common.patterns.visitor;

import com.example.labs.common.model.Track;

public interface Visitor {
    void visitTrack(Track track);
}

package com.example.labs.server;

import com.example.labs.common.NetworkRequest;
import com.example.labs.common.NetworkResponse;
import com.example.labs.common.model.*;
import com.example.labs.common.patterns.memento.PlayerMemento;
import com.example.labs.server.repository.StateRepository;
import com.example.labs.server.service.*;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.util.List;

public class ClientHandler extends Thread {

    private final Socket socket;
    private final UserService userService;
    private final TrackService trackService;
    private final PlaylistService playlistService;
    private final StateRepository stateRepository;

    public ClientHandler(Socket socket,
                         UserService userService,
                         TrackService trackService,
                         PlaylistService playlistService,
                         StateRepository stateRepository) {
        this.socket = socket;
        this.userService = userService;
        this.trackService = trackService;
        this.playlistService = playlistService;
        this.stateRepository = stateRepository;
    }

    @Override
    public void run() {
        try (
                // –ü–æ—Ç–æ–∫–∏ –≤–≤–µ–¥–µ–Ω–Ω—è/–≤–∏–≤–µ–¥–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤
                ObjectOutputStream out = new ObjectOutputStream(socket.getOutputStream());
                ObjectInputStream in = new ObjectInputStream(socket.getInputStream())
        ) {
            // –ß–∏—Ç–∞—î–º–æ –∑–∞–ø–∏—Ç –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞
            Object inputObject = in.readObject();
            if (inputObject instanceof NetworkRequest) {
                NetworkRequest request = (NetworkRequest) inputObject;

                // –û–±—Ä–æ–±–ª—è—î–º–æ –∑–∞–ø–∏—Ç —ñ –æ—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                NetworkResponse response = handleRequest(request);

                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É
                out.writeObject(response);
                out.flush();
            }
        } catch (Exception e) {
            System.err.println("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞: " + e.getMessage());
            // e.printStackTrace(); // –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –¥–ª—è –¥–µ–±–∞–≥—É
        } finally {
            try {
                socket.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    private NetworkResponse handleRequest(NetworkRequest req) {
        String command = req.getCommand();
        Object payload = req.getPayload();

        System.out.println("–û—Ç—Ä–∏–º–∞–Ω–æ –∫–æ–º–∞–Ω–¥—É: " + command);

        try {
            switch (command) {
                // --- –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø ---
                case "LOGIN":
                    String[] loginData = (String[]) payload; // [email, password]
                    User user = userService.login(loginData[0], loginData[1]);// [cite: 106]
                    return new NetworkResponse(user != null, user);

                case "REGISTER":
                    String[] regData = (String[]) payload; // [name, email, password]
                    User newUser = userService.register(regData[0], regData[1], regData[2]);// [cite: 109]
                    return new NetworkResponse(newUser != null, newUser);

                // --- –¢–†–ï–ö–ò ---
                case "GET_USER_TRACKS":
                    int userId = (int) payload;
                    List<Track> tracks = trackService.getAllTracks(userId);// [cite: 114]
                    return new NetworkResponse(true, tracks);

                case "ADD_TRACK":
                    Object[] addData = (Object[]) payload;
                    int trackOwnerId = (int) addData[0];
                    Track track = (Track) addData[1];
                    trackService.addTrack(track);
                    if (track.getTrackID() != 0) {
                        trackService.linkTrackToUser(trackOwnerId, track.getTrackID());
                    }

                    return new NetworkResponse(true, track);

                case "GET_USER_PLAYLISTS":
                    int pUserId = (int) payload;
                    List<Playlist> playlists = playlistService.getAllPlaylists(pUserId);// [cite: 115]
                    return new NetworkResponse(true, playlists);

                case "CREATE_PLAYLIST":
                    Playlist pl = (Playlist) payload;
                    playlistService.createPlaylist(pl);// [cite: 78]
                    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π –ø–ª–µ–π–ª–∏—Å—Ç (–∑ ID)
                    return new NetworkResponse(true, pl);

                case "LINK_PLAYLIST_USER":
                    // –û—á—ñ–∫—É—î–º–æ int[]{userId, playlistId}
                    int[] linkData = (int[]) payload;
                    playlistService.linkPlaylistToUser(linkData[0], linkData[1]);// [cite: 78]
                    return new NetworkResponse(true, null);

                // --- –°–¢–ê–ù (MEMENTO) ---
                case "SAVE_STATE":
                    // –û—á—ñ–∫—É—î–º–æ –æ–±'—î–∫—Ç, —â–æ –º—ñ—Å—Ç–∏—Ç—å userId —ñ memento
                    // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, Object[]{userId, memento}
                    Object[] stateData = (Object[]) payload;
                    stateRepository.saveState((int) stateData[0], (PlayerMemento) stateData[1]);// [cite: 95]
                    return new NetworkResponse(true, null);

                case "LOAD_STATE":
                    int sUserId = (int) payload;
                    PlayerMemento memento = stateRepository.loadState(sUserId);// [cite: 92]
                    return new NetworkResponse(true, memento);
                // –£ –º–µ—Ç–æ–¥ handleRequest –¥–æ–¥–∞–π—Ç–µ:

                case "GET_TRACK":
                    int tId = (int) payload;
                    Track t = trackService.getTrackByID(tId);
                    return new NetworkResponse(t != null, t);

                case "DELETE_TRACK":
                    trackService.deleteTrack((int) payload);
                    return new NetworkResponse(true, null);

                case "UPDATE_TRACK":
                    trackService.updateTrack((Track) payload);
                    return new NetworkResponse(true, null);

                case "LINK_TRACK_USER":
                    int[] linkTrackData = (int[]) payload;
                    trackService.linkTrackToUser(linkTrackData[0], linkTrackData[1]);
                    return new NetworkResponse(true, null);

                case "GET_PLAYLIST":
                    int pId = (int) payload;
                    Playlist playlist = playlistService.getPlaylistByID(pId);
                    return new NetworkResponse(playlist != null, playlist);

                case "DELETE_PLAYLIST":
                    playlistService.deletePlaylist((int) payload);
                    return new NetworkResponse(true, null);

                case "UPDATE_PLAYLIST":
                    playlistService.updatePlaylist((Playlist) payload);
                    return new NetworkResponse(true, null);

                case "GET_USER":
                    int userIdForSearch = (int) payload;
                    User foundUser = userService.getUserByID(userIdForSearch);
                    return new NetworkResponse(foundUser != null, foundUser);

                default:
                    return new NetworkResponse(false, "–ù–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞: " + command);
            }
        } catch (Exception e) {
            e.printStackTrace();
            return new NetworkResponse(false, "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + e.getMessage());
        }
    }
}

package com.example.labs.server;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;

public class DatabaseConnection {

    private static final String URL = "jdbc:sqlite:music_player.db";
    private static volatile Connection instance;

    private DatabaseConnection() {}

    public static Connection connect() throws SQLException {
        if (instance == null || instance.isClosed()) {
            synchronized (DatabaseConnection.class) {
                if (instance == null || instance.isClosed()) {
                    instance = DriverManager.getConnection(URL);
                    configureConnection(instance);
                }
            }
        }
        return instance;
    }

    private static void configureConnection(Connection conn) throws SQLException {
        try (Statement stmt = conn.createStatement()) {
            stmt.execute("PRAGMA foreign_keys = ON;");
        }
    }

    public static void initSchema() {
        try (Connection conn = connect(); Statement stmt = conn.createStatement()) {

            // 1. –¢—Ä–µ–∫–∏ –∑ –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º
            stmt.execute("CREATE TABLE IF NOT EXISTS tracks (" +
                    "id INTEGER PRIMARY KEY AUTOINCREMENT, " + // –ó–ú–Ü–ù–ï–ù–û
                    "title TEXT, " +
                    "artist TEXT, " +
                    "album TEXT, " +
                    "duration REAL, " +
                    "filepath TEXT)");

            // 2. –ü–ª–µ–π–ª–∏—Å—Ç–∏ –∑ –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º
            stmt.execute("CREATE TABLE IF NOT EXISTS playlists (" +
                    "id INTEGER PRIMARY KEY AUTOINCREMENT, " + // –ó–ú–Ü–ù–ï–ù–û
                    "name TEXT)");

            // ... —Ç–∞–±–ª–∏—Ü—ñ –∑–≤'—è–∑–∫—ñ–≤ —Ç–∞ —é–∑–µ—Ä—ñ–≤ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω ...
            stmt.execute("CREATE TABLE IF NOT EXISTS playlist_tracks (" +
                    "playlist_id INTEGER, track_id INTEGER, " +
                    "FOREIGN KEY(playlist_id) REFERENCES playlists(id) ON DELETE CASCADE, " +
                    "FOREIGN KEY(track_id) REFERENCES tracks(id) ON DELETE CASCADE)");

            stmt.execute("CREATE TABLE IF NOT EXISTS users (" +
                    "id INTEGER PRIMARY KEY AUTOINCREMENT, " + // –Æ–∑–µ—Ä–∏ —Ç–µ–∂
                    "name TEXT, email TEXT UNIQUE, password TEXT)");

            stmt.execute("CREATE TABLE IF NOT EXISTS users_tracks (" +
                    "user_id INTEGER, track_id INTEGER, " +
                    "PRIMARY KEY (user_id, track_id), " +
                    "FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE, " +
                    "FOREIGN KEY(track_id) REFERENCES tracks(id) ON DELETE CASCADE)");

            stmt.execute("CREATE TABLE IF NOT EXISTS users_playlists (" +
                    "user_id INTEGER, playlist_id INTEGER, " +
                    "PRIMARY KEY (user_id, playlist_id), " +
                    "FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE, " +
                    "FOREIGN KEY(playlist_id) REFERENCES playlists(id) ON DELETE CASCADE)");

            stmt.execute("INSERT OR IGNORE INTO users (id, name, email, password) VALUES (1, 'Default User', 'default@mp.com', '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918')");
            stmt.execute("CREATE TABLE IF NOT EXISTS playback_state (" +
                    "user_id INTEGER PRIMARY KEY, " +
                    "volume INTEGER, " +
                    "is_shuffle INTEGER, " +
                    "is_repeat INTEGER, " +
                    "current_track_id INTEGER, " +
                    "source_type INTEGER, " +
                    "source_id INTEGER, " +
                    "current_time REAL, " + // <-- –ù–û–í–ê –ö–û–õ–û–ù–ö–ê
                    "FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE)");

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}

package com.example.labs.server.repository;

import java.util.List;

public interface IRepository<T> {
    T findByID(int id);
    List<T> findAll();
    void update(T entity); // –í–∏–∫–æ–Ω—É—î —Ä–æ–ª—å Save/Update
    void delete(int id);
}

package com.example.labs.server.repository;

import com.example.labs.common.model.Playlist;
import com.example.labs.server.DatabaseConnection;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;


public class PlaylistRepository implements IRepository<Playlist> {
    @Override
    public Playlist findByID(int id) {
        String sql = "SELECT id, name FROM playlists WHERE id = ?";
        Playlist playlist = null;

        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, id);
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                playlist = new Playlist(rs.getInt("id"), rs.getString("name"));
                loadPlaylistTracks(playlist, conn);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return playlist;
    }

    @Override
    public List<Playlist> findAll() {
        List<Playlist> playlists = new ArrayList<>();
        String sql = "SELECT id, name FROM playlists";

        try (Connection conn = DatabaseConnection.connect();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {

            while (rs.next()) {
                Playlist pl = new Playlist(rs.getInt("id"), rs.getString("name"));
                loadPlaylistTracks(pl, conn);
                playlists.add(pl);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return playlists;
    }

    @Override
    public void update(Playlist playlist) {
        if (playlist.getPlaylistID() == 0) {
            // --- INSERT ---
            String sql = "INSERT INTO playlists(name) VALUES(?)";
            try (Connection conn = DatabaseConnection.connect();
                 PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {

                pstmt.setString(1, playlist.getName());
                int affectedRows = pstmt.executeUpdate();

                if (affectedRows > 0) {
                    try (ResultSet rs = pstmt.getGeneratedKeys()) {
                        if (rs.next()) {
                            playlist.setPlaylistID(rs.getInt(1)); // –û—Ç—Ä–∏–º—É—î–º–æ ID
                        }
                    }
                }
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—Ä–µ–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ (—Ö–æ—á–∞ –≤—ñ–Ω –∑–∞–∑–≤–∏—á–∞–π –ø–æ—Ä–æ–∂–Ω—ñ–π –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ)
                savePlaylistTracks(playlist, conn);

            } catch (SQLException e) { e.printStackTrace(); }
        } else {
            // --- UPDATE ---
            String sql = "UPDATE playlists SET name=? WHERE id=?";
            try (Connection conn = DatabaseConnection.connect()) {
                try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                    pstmt.setString(1, playlist.getName());
                    pstmt.setInt(2, playlist.getPlaylistID());
                    pstmt.executeUpdate();
                }
                // –û–Ω–æ–≤–ª—é—î–º–æ –∑–≤'—è–∑–∫–∏ —Ç—Ä–µ–∫—ñ–≤
                savePlaylistTracks(playlist, conn);
            } catch (SQLException e) { e.printStackTrace(); }
        }
    }

    // –í–∏–Ω—ñ—Å –ª–æ–≥—ñ–∫—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç—Ä–µ–∫—ñ–≤ –≤ –æ–∫—Ä–µ–º–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏
    private void savePlaylistTracks(Playlist playlist, Connection conn) throws SQLException {
        String sqlDelete = "DELETE FROM playlist_tracks WHERE playlist_id = ?";
        try (PreparedStatement pstmt = conn.prepareStatement(sqlDelete)) {
            pstmt.setInt(1, playlist.getPlaylistID());
            pstmt.executeUpdate();
        }

        if (!playlist.getTracks().isEmpty()) {
            String sqlInsert = "INSERT INTO playlist_tracks(playlist_id, track_id) VALUES(?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sqlInsert)) {
                for (Integer trackId : playlist.getTracks()) {
                    pstmt.setInt(1, playlist.getPlaylistID());
                    pstmt.setInt(2, trackId);
                    pstmt.addBatch();
                }
                pstmt.executeBatch();
            }
        }
    }

    @Override
    public void delete(int id) {
        String sql = "DELETE FROM playlists WHERE id = ?";

        try (PreparedStatement pstmt = DatabaseConnection.connect().prepareStatement(sql)) {

            pstmt.setInt(1, id);
            pstmt.executeUpdate();

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void loadPlaylistTracks(Playlist playlist, Connection conn) throws SQLException {
        String sql = "SELECT track_id FROM playlist_tracks WHERE playlist_id = ?";
        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setInt(1, playlist.getPlaylistID());
            ResultSet rs = pstmt.executeQuery();
            while (rs.next()) {
                playlist.addTrack(rs.getInt("track_id"));
            }
        }
    }

    public List<Playlist> findPlaylistsByUserId(int userId) {
        List<Playlist> playlists = new ArrayList<>();
        String sql = "SELECT p.* FROM playlists p JOIN users_playlists up ON p.id = up.playlist_id WHERE up.user_id = ?";
        // ... —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ TrackRepository ...
        return playlists;
    }

    public void linkPlaylistToUser(int userId, int playlistId) {
        String sql = "INSERT OR IGNORE INTO users_playlists (user_id, playlist_id) VALUES (?, ?)";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, userId);
            pstmt.setInt(2, playlistId);
            pstmt.executeUpdate();

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // –£ —Ñ–∞–π–ª—ñ com/example/kursova/repository/PlaylistRepository.java

    public List<Playlist> findAllByUserId(int userId) {
        List<Playlist> playlists = new ArrayList<>();
        String sql = "SELECT p.id, p.name " +
                "FROM playlists p " +
                "JOIN users_playlists up ON p.id = up.playlist_id " +
                "WHERE up.user_id = ?";

        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, userId);
            ResultSet rs = pstmt.executeQuery();

            while (rs.next()) {
                Playlist pl = new Playlist(rs.getInt("id"), rs.getString("name"));
                // –í–∞–∂–ª–∏–≤–æ: –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫—ñ–≤ –¥–ª—è —Ü—å–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞
                loadPlaylistTracks(pl, conn);
                playlists.add(pl);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return playlists;
    }
}


package com.example.labs.server.repository;

import com.example.labs.common.patterns.memento.PlayerMemento;
import com.example.labs.server.DatabaseConnection;

import java.sql.*;

public class StateRepository {
    // com.example.labs.server.repository.StateRepository

    public void saveState(int userId, PlayerMemento memento) {
        String sql = "INSERT OR REPLACE INTO playback_state (user_id, volume, is_shuffle, is_repeat, current_track_id, source_type, source_id, current_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, userId);
            pstmt.setInt(2, memento.getVolume());
            pstmt.setInt(3, memento.isShuffle() ? 1 : 0);
            pstmt.setInt(4, memento.isRepeat() ? 1 : 0);
            pstmt.setInt(5, memento.getCurrentTrackId());
            pstmt.setInt(6, memento.getSourceType());
            pstmt.setInt(7, memento.getSourceId());
            pstmt.setDouble(8, memento.getCurrentTime()); // <-- –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å

            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public PlayerMemento loadState(int userId) {
        String sql = "SELECT volume, is_shuffle, is_repeat, current_track_id, source_type, source_id, current_time FROM playback_state WHERE user_id = ?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, userId);
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                return new PlayerMemento(
                        rs.getInt("volume"),
                        rs.getBoolean("is_shuffle"),
                        rs.getBoolean("is_repeat"),
                        rs.getInt("current_track_id"),
                        rs.getInt("source_type"),
                        rs.getInt("source_id"),
                        rs.getDouble("current_time") // <-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —á–∞—Å
                );
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
}

package com.example.labs.server.repository;


import com.example.labs.common.model.Track;
import com.example.labs.server.DatabaseConnection;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class TrackRepository implements IRepository<Track> {
    @Override
    public Track findByID(int id) {
        String sql = "SELECT id, title, artist, album, duration, filepath FROM tracks WHERE id = ?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, id);
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                return mapRowToTrack(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    @Override
    public List<Track> findAll() {
        List<Track> tracks = new ArrayList<>();
        String sql = "SELECT id, title, artist, album, duration, filepath FROM tracks";

        try (Connection conn = DatabaseConnection.connect();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {

            while (rs.next()) {
                tracks.add(mapRowToTrack(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return tracks;
    }

    @Override
    public void update(Track track) {
        if (track.getTrackID() == 0) {
            // --- INSERT (–°—Ç–≤–æ—Ä–µ–Ω–Ω—è) ---
            String sql = "INSERT INTO tracks(title, artist, album, duration, filepath) VALUES(?, ?, ?, ?, ?)";
            try (Connection conn = DatabaseConnection.connect();
                 PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {

                pstmt.setString(1, track.getTitle());
                pstmt.setString(2, track.getArtist());
                pstmt.setString(3, track.getAlbum());
                pstmt.setDouble(4, track.getDuration());
                pstmt.setString(5, track.getFilePath());

                int affectedRows = pstmt.executeUpdate();
                if (affectedRows > 0) {
                    try (ResultSet rs = pstmt.getGeneratedKeys()) {
                        if (rs.next()) {
                            track.setTrackID(rs.getInt(1)); // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π ID –æ–±'—î–∫—Ç—É
                        }
                    }
                }
            } catch (SQLException e) { e.printStackTrace(); }
        } else {
            // --- UPDATE (–û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ) ---
            String sql = "UPDATE tracks SET title=?, artist=?, album=?, duration=?, filepath=? WHERE id=?";
            try (Connection conn = DatabaseConnection.connect();
                 PreparedStatement pstmt = conn.prepareStatement(sql)) {

                pstmt.setString(1, track.getTitle());
                pstmt.setString(2, track.getArtist());
                pstmt.setString(3, track.getAlbum());
                pstmt.setDouble(4, track.getDuration());
                pstmt.setString(5, track.getFilePath());
                pstmt.setInt(6, track.getTrackID());

                pstmt.executeUpdate();
            } catch (SQLException e) { e.printStackTrace(); }
        }
    }
    @Override
    public void delete(int id) {
        String sql = "DELETE FROM tracks WHERE id = ?";

        try (PreparedStatement pstmt = DatabaseConnection.connect().prepareStatement(sql)) {

            pstmt.setInt(1, id);
            pstmt.executeUpdate();

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private Track mapRowToTrack(ResultSet rs) throws SQLException {
        return new Track(
                rs.getInt("id"),
                rs.getString("title"),
                rs.getString("artist"),
                rs.getString("album"),
                rs.getDouble("duration"),
                rs.getString("filepath")
        );
    }

    public List<Track> findTracksByUserId(int userId) {
        List<Track> tracks = new ArrayList<>();
        String sql = "SELECT t.* FROM tracks t JOIN users_tracks ut ON t.id = ut.track_id WHERE ut.user_id = ?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setInt(1, userId);
            ResultSet rs = pstmt.executeQuery();
            while (rs.next()) tracks.add(mapRowToTrack(rs));
        } catch (SQLException e) { e.printStackTrace(); }
        return tracks;
    }

    public void linkTrackToUser(int userId, int trackId) {
        String sql = "INSERT OR IGNORE INTO users_tracks (user_id, track_id) VALUES (?, ?)";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setInt(1, userId);
            pstmt.setInt(2, trackId);
            pstmt.executeUpdate();
        } catch (SQLException e) { e.printStackTrace(); }
    }

    // –£ —Ñ–∞–π–ª—ñ com/example/kursova/repository/TrackRepository.java

    public List<Track> findAllByUserId(int userId) {
        List<Track> tracks = new ArrayList<>();
        // –ó–∞–ø–∏—Ç –æ–±'—î–¥–Ω—É—î —Ç–∞–±–ª–∏—Ü—é —Ç—Ä–µ–∫—ñ–≤ —ñ —Ç–∞–±–ª–∏—Ü—é –∑–≤'—è–∑–∫—ñ–≤
        String sql = "SELECT t.id, t.title, t.artist, t.album, t.duration, t.filepath " +
                "FROM tracks t " +
                "JOIN users_tracks ut ON t.id = ut.track_id " +
                "WHERE ut.user_id = ?";

        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, userId);
            ResultSet rs = pstmt.executeQuery();

            while (rs.next()) {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á–∏–π –º–µ—Ç–æ–¥ –º–∞–ø–ø—ñ–Ω–≥—É
                tracks.add(mapRowToTrack(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return tracks;
    }
}


package com.example.labs.server.repository;

import com.example.labs.common.model.User;
import com.example.labs.server.DatabaseConnection;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class UserRepository implements IRepository<User> {

    @Override
    public User findByID(int id) {
        String sql = "SELECT id, name, email, password FROM users WHERE id = ?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setInt(1, id);
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                return mapRowToUser(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ—à—É–∫—É –ø–æ Email
    public User findByEmail(String email) {
        String sql = "SELECT id, name, email, password FROM users WHERE email = ?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setString(1, email);
            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) return mapRowToUser(rs);
        } catch (SQLException e) { e.printStackTrace(); }
        return null;
    }

    @Override
    public List<User> findAll() {
        List<User> users = new ArrayList<>();
        String sql = "SELECT id, name, email, password FROM users";
        try (Connection conn = DatabaseConnection.connect();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            while (rs.next()) {
                users.add(mapRowToUser(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return users;
    }

    // –í–ê–ñ–õ–ò–í–û: –¶–µ–π –º–µ—Ç–æ–¥ —á–∞—Å—Ç–æ —î –ø—Ä–∏—á–∏–Ω–æ—é –ø–æ–º–∏–ª–∫–∏
    public int createUser(User user) {
        // –ú–∏ –ù–ï –ø–µ—Ä–µ–¥–∞—î–º–æ 'id' (–≤—ñ–Ω AUTOINCREMENT) —ñ –ù–ï –ø–µ—Ä–µ–¥–∞—î–º–æ 'settings' (–º–∏ —ó—Ö –≤–∏–¥–∞–ª–∏–ª–∏)
        String sql = "INSERT INTO users(name, email, password) VALUES(?, ?, ?)";

        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {

            pstmt.setString(1, user.getName());
            pstmt.setString(2, user.getEmail());
            pstmt.setString(3, user.getPassword());

            int affectedRows = pstmt.executeUpdate();

            if (affectedRows > 0) {
                try (ResultSet rs = pstmt.getGeneratedKeys()) {
                    if (rs.next()) return rs.getInt(1); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ–≤–∏–π ID
                }
            }
        } catch (SQLException e) {
            // –Ø–∫—â–æ —Ç—É—Ç –ø–æ–º–∏–ª–∫–∞ - —É –∫–æ–Ω—Å–æ–ª—ñ –±—É–¥–µ –ø—Ä–∏—á–∏–Ω–∞, –∞ –º–µ—Ç–æ–¥ –ø–æ–≤–µ—Ä–Ω–µ -1
            e.printStackTrace();
        }
        return -1;
    }

    @Override
    public void update(User user) {
        String sql = "UPDATE users SET name=?, email=?, password=? WHERE id=?";
        try (Connection conn = DatabaseConnection.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setString(1, user.getName());
            pstmt.setString(2, user.getEmail());
            pstmt.setString(3, user.getPassword());
            pstmt.setInt(4, user.getUserID());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void delete(int id) {
        String sql = "DELETE FROM users WHERE id = ?";
        try (PreparedStatement pstmt = DatabaseConnection.connect().prepareStatement(sql)) {
            pstmt.setInt(1, id);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private User mapRowToUser(ResultSet rs) throws SQLException {
        return new User(
                rs.getInt("id"),
                rs.getString("name"),
                rs.getString("email"),
                rs.getString("password")
                // settings –≤–∏–¥–∞–ª–µ–Ω–æ, —Ç—É—Ç –π–æ–≥–æ –±—É—Ç–∏ –Ω–µ –ø–æ–≤–∏–Ω–Ω–æ
        );
    }
}

package com.example.labs.server;

import com.example.labs.server.repository.*;
import com.example.labs.server.service.*;
import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;

public class ServerApp {

    private static final int PORT = 8888;

    public static void main(String[] args) {
        System.out.println(">>> –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞...");

        // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å)
        try {
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–≥—ñ–∫—É –∑ —Å—Ç–∞—Ä–æ–≥–æ DatabaseConnection
            DatabaseConnection.initSchema(); //// [cite: 99, 355]
            System.out.println(">>> –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞.");
        } catch (Exception e) {
            System.err.println("!!! –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ë–î:");
            e.printStackTrace();
            return;
        }

        // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —à–∞—Ä—ñ–≤ (Repository -> Service)
        // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç–∏, —è–∫—ñ –±—É–¥—É—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏ –ª–æ–≥—ñ–∫—É
        UserRepository userRepo = new UserRepository(); // [cite: 101]
        TrackRepository trackRepo = new TrackRepository(); // [cite: 102]
        PlaylistRepository playlistRepo = new PlaylistRepository(); // [cite: 102]
        StateRepository stateRepo = new StateRepository(); // [cite: 6]

        UserService userService = new UserService(userRepo); // [cite: 102]
        TrackService trackService = new TrackService(trackRepo); // [cite: 102]
        PlaylistService playlistService = new PlaylistService(playlistRepo); // [cite: 103]

        // 3. –ó–∞–ø—É—Å–∫ –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        try (ServerSocket serverSocket = new ServerSocket(PORT)) {
            System.out.println(">>> –°–µ—Ä–≤–µ—Ä —Å–ª—É—Ö–∞—î –ø–æ—Ä—Ç " + PORT);
            System.out.println(">>> –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤...");

            while (true) {
                // –ë–ª–æ–∫—É—î—Ç—å—Å—è, –ø–æ–∫–∏ –Ω–µ –ø—ñ–¥'—î–¥–Ω–∞—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç
                Socket clientSocket = serverSocket.accept();
                System.out.println(">>> –ù–æ–≤–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: " + clientSocket.getInetAddress());

                // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø–æ—Ç—ñ–∫ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞, –ø–µ—Ä–µ–¥–∞—é—á–∏ –π–æ–º—É —Å–µ—Ä–≤—ñ—Å–∏
                ClientHandler handler = new ClientHandler(
                        clientSocket,
                        userService,
                        trackService,
                        playlistService,
                        stateRepo
                );
                handler.start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

package com.example.labs.server.service;


import com.example.labs.common.model.Playlist;
import com.example.labs.server.repository.PlaylistRepository;
import java.util.List;

public class PlaylistService {

    private PlaylistRepository playlistRepository;

    public PlaylistService(PlaylistRepository playlistRepository) {
        this.playlistRepository = playlistRepository;
    }

    public Playlist createPlaylist(Playlist playlist) {
        if (playlist != null) {
            playlistRepository.update(playlist);
            return playlist;
        }
        return null;
    }

    public void updatePlaylist(Playlist playlist) {
        // –õ–æ–≥—ñ–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤ –ë–î
        playlistRepository.update(playlist);
    }

    public void deletePlaylist(int id) {
        playlistRepository.delete(id);
    }

    public List<Playlist> getAllPlaylists() {
        return playlistRepository.findAll();
    }

    public Playlist getPlaylistByID(int id) {
        return playlistRepository.findByID(id);
    }

    public List<Playlist> getAllPlaylists(int userId) {
        return playlistRepository.findAllByUserId(userId);
    }

    public void linkPlaylistToUser(int userId, int playlistId) {
        playlistRepository.linkPlaylistToUser(userId, playlistId);
    }
}

package com.example.labs.server.service;

import com.example.labs.common.model.Track;
import com.example.labs.server.repository.TrackRepository;
import java.util.List;

public class TrackService {

    private TrackRepository trackRepository;

    public TrackService(TrackRepository trackRepository) {
        this.trackRepository = trackRepository;
    }

    public void addTrack(Track track) {
        if (track != null && track.getFilePath() != null) {
            trackRepository.update(track);
        }
    }

    public void updateTrack(Track track) {
        trackRepository.update(track);
    }

    public void deleteTrack(int id) {
        trackRepository.delete(id);
    }

    public List<Track> getAllTracks() {
        return trackRepository.findAll();
    }

    public Track getTrackByID(int id) {
        return trackRepository.findByID(id);
    }

    public List<Track> getAllTracks(int userId) {
        // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —é–∑–µ—Ä–∞
        return trackRepository.findAllByUserId(userId);
    }

    public void linkTrackToUser(int userId, int trackId) {
        trackRepository.linkTrackToUser(userId, trackId);
    }
}


package com.example.labs.server.service;

import com.example.labs.common.model.User;
import com.example.labs.server.repository.UserRepository;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.List;

public class UserService {

    private UserRepository userRepository;

    public UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ú–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó ---
    public User login(String email, String password) {
        User user = userRepository.findByEmail(email);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î —é–∑–µ—Ä —ñ —á–∏ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å –•–ï–®–Ü –ø–∞—Ä–æ–ª—ñ–≤
        if (user != null && user.getPassword().equals(hashPassword(password))) {
            return user;
        }
        return null;
    }

    // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ú–µ—Ç–æ–¥ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó ---
    public User register(String name, String email, String password) {
        if (userRepository.findByEmail(email) != null) return null;

        // –•–µ—à—É—î–º–æ –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –æ–±'—î–∫—Ç–∞
        String hashedPassword = hashPassword(password);

        // –°—Ç–≤–æ—Ä—é—î–º–æ —é–∑–µ—Ä–∞ –≤–∂–µ –∑ –∑–∞—Ö–µ—à–æ–≤–∞–Ω–∏–º –ø–∞—Ä–æ–ª–µ–º
        User newUser = new User(0, name, email, hashedPassword);

        int id = userRepository.createUser(newUser);
        if (id != -1) {
            newUser.setUserID(id);
            return newUser;
        }
        return null;
    }

    // –Ü–Ω—à—ñ –º–µ—Ç–æ–¥–∏ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω...

    public User registerUser(User user) {
        // –Ø–∫—â–æ —Ü–µ–π –º–µ—Ç–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≥–æ—Ç–æ–≤–æ–≥–æ –æ–±'—î–∫—Ç–∞,
        // –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø–∞—Ä–æ–ª—å —Ç–∞–º –≤–∂–µ –∑–∞—Ö–µ—à–æ–≤–∞–Ω–∏–π, –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –ª–æ–≥—ñ–∫—É —Ç—É—Ç.
        userRepository.update(user);
        return user;
    }

    public void updateUser(User user) {
        // –ü—Ä–∏–º—ñ—Ç–∫–∞: –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω—é—î –ø–∞—Ä–æ–ª—å, –π–æ–≥–æ —Ç–µ–∂ —Ç—Ä–µ–±–∞ —Ö–µ—à—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º —Ü—å–æ–≥–æ –º–µ—Ç–æ–¥—É
        userRepository.update(user);
    }

    public void deleteUser(int id) {
        userRepository.delete(id);
    }

    public List<User> getAllUsers() {
        return userRepository.findAll();
    }

    public User getUserByID(int id) {
        return userRepository.findByID(id);
    }

    // --- –ù–û–í–ò–ô –ú–ï–¢–û–î: –•–µ—à—É–≤–∞–Ω–Ω—è (SHA-256) ---
    private String hashPassword(String plainTextPassword) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] encodedhash = digest.digest(plainTextPassword.getBytes(StandardCharsets.UTF_8));
            return bytesToHex(encodedhash);
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("–ü–æ–º–∏–ª–∫–∞ —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è", e);
        }
    }

    // –î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–π—Ç—ñ–≤ —É —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–π —Ä—è–¥–æ–∫ (Hex)
    private String bytesToHex(byte[] hash) {
        StringBuilder hexString = new StringBuilder(2 * hash.length);
        for (byte b : hash) {
            String hex = Integer.toHexString(0xff & b);
            if (hex.length() == 1) {
                hexString.append('0');
            }
            hexString.append(hex);
        }
        return hexString.toString();
    }
}